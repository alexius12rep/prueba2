<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador Acad√©mico Inteligente</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <!-- Font Audiowide SOLO para el logo -->
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
    <!-- Font Awesome para √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #050916;
            --color-secondary: #0b5657;
            --color-accent: #0d3430;
            --color-light: #ffffff;
            --color-dark: #0080ff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #032711;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
            --header-height: 50px;
            --settings-btn-size: 50px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            min-height: 100vh;
            color: var(--color-text);
            overflow-x: hidden;
            position: relative;
            transition: 0.3s, color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Ajuste para cuando el usuario est√° logueado */
        body.logged-in .app-container {
            padding-top: 0; /* Elimina el padding superior cuando el usuario est√° logueado */
        }

        body.logged-in .top-header {
            display: none; /* Oculta la cabecera cuando el usuario est√° logueado */
        }

        /* Logo principal - SOLO aqu√≠ aplicamos Audiowide */
        .login-title, .logo-title {
            font-family: 'Audiowide', cursive !important;
            font-size: 1.8rem;
            color: var(--color-text);
            text-align: center;
        }

        /* Eliminamos Audiowide de TODOS los botones y dem√°s elementos */
        .add-materia-btn,
        .btn,
        .settings-menu,
        .settings-item,
        .modal-title,
        .section-title,
        .app-title,
        .sidebar-title,
        .auth-btn,
        .login-btn,
        .tarea-btn,
        .custom-dialog-btn,
        .skip-btn,
        .fixed-buttons-container button,
        .add-group-btn { /* Added .add-group-btn here */
            font-weight: 600; 
            letter-spacing: 0.5px; 
        }

        .background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('logosinfondo.png');
            background-size: 30%;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
            background-attachment: fixed;
        }

        /* Header superior */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            border-bottom: 1px solid var(--color-border);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .google-icon {
            width: 24px;
            height: 24px;
            margin-right: 5px;
        }

        .auth-btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .auth-btn.login {
            background: var(--color-accent);
        }

        .auth-btn.register {
            background: var(--color-secondary);
        }

        /* Bot√≥n de configuraci√≥n flotante */
        .settings-btn-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .settings-btn {
            width: var(--settings-btn-size);
            height: var(--settings-btn-size);
            border-radius: 50%;
            background: var(--color-accent);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            position: relative;
        }

        .settings-btn:hover {
            transform: scale(1.1) rotate(30deg);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .settings-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: calc(100% + 10px);
            white-space: nowrap;
            background: transparent;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-family: 'Audiowide', cursive;
            overflow: hidden;
            width: 0;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        .settings-icon {
            font-size: 1.5rem;
            color: white;
        }

        .settings-menu {
            position: absolute;
            bottom: calc(var(--settings-btn-size) + 10px);
            right: 0;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 10px 0;
            min-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            border: 1px solid var(--color-border);
        }

        .settings-menu.active {
            display: block;
        }

        .settings-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-text);
            position: relative; /* Added for sub-options positioning */
        }

        .settings-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-item.logout {
            color: var(--color-danger);
        }

        .theme-options, .role-options, .notification-settings {
            display: none;
            flex-direction: column;
            padding: 10px;
            gap: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin: 5px;
            position: absolute; 
            right: calc(100% + 20px); /* Aumentado el espacio */
            top: 50%; /* Centrado verticalmente */
            transform: translateY(-50%); /* Ajuste para centrar */
            min-width: 200px;
            z-index: 1002; 
        }

        .theme-options.active, .role-options.active, .notification-settings.active {
            display: flex;
        }

        .theme-option, .role-option {
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid var(--color-border);
            transition: all 0.3s;
            color: white;
            text-align: center;
            position: relative;
        }

        .theme-option:hover, .role-option:hover {
            transform: scale(1.02);
        }

        .theme-option.active::after, .role-option.active::after {
            content: '‚úì';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

        /* Di√°logo personalizado */
        .custom-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            z-index: 1100;
            display: none;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--color-border);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            max-width: 80%;
            width: 300px;
            font-family: 'Audiowide', cursive;
        }

        .custom-dialog.active {
            display: flex;
        }

        .custom-dialog-message {
            margin-bottom: 20px;
            text-align: center;
        }

        .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .custom-dialog-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Audiowide', cursive;
        }

        .custom-dialog-btn.confirm {
            background: var(--color-danger);
            color: white;
        }

        .custom-dialog-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
        }

        .custom-dialog-btn:hover {
            opacity: 0.9;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            padding-top: var(--header-height);
        }

        /* Logo y t√≠tulo - Solo 'LOUVLE' con Audiowide */
        .logo-title {
            font-family: 'Audiowide', cursive;
            font-size: 1.8rem;
            color: var(--color-text);
            text-align: center;
            padding: 20px 0 10px 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 20px;
        }

        /* T√≠tulos de secci√≥n sin Audiowide */
        .sidebar-title, .modal-title, .section-title, .app-title {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Men√∫ lateral */
        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 0 20px 20px 20px;
            transition: transform 0.3s;
            border-right: 1px solid var(--color-border);
            position: relative;
            z-index: 10;
            display: flex; /* A√±adido para flexbox */
            flex-direction: column; /* A√±adido para flexbox */
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        .materias-list, .groups-list {
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }

        /* Estilos para Materias */
        .materia-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: var(--color-bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .materia-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .materia-item.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .materia-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
            color: var(--color-text-secondary);
        }

        .materia-actions {
            display: none;
        }

        .materia-item:hover .materia-actions {
            display: flex;
            gap: 5px;
        }

        .materia-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.8rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .materia-btn.eliminar {
            background: var(--color-danger);
        }

        .materia-btn.eliminar:hover {
            background: #c82333;
        }

        .add-materia-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: var(--color-accent);
            border: none;
            border-radius: 8px;
            color: var(--color-text);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-materia-btn:hover {
            background: #002343;
        }

        /* Estilos para Grupos (nuevas clases) */
        .group-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: var(--color-bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .group-item.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .group-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
            color: var(--color-text-secondary);
        }

        .group-actions {
            display: none;
        }

        .group-item:hover .group-actions {
            display: flex;
            gap: 5px;
        }

        .group-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.8rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .group-btn.eliminar {
            background: var(--color-danger);
        }

        .group-btn.eliminar:hover {
            background: #c82333;
        }

        .add-group-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: var(--color-accent);
            border: none;
            border-radius: 8px;
            color: var(--color-text);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-group-btn:hover {
            background: #002343;
        }


        /* Login info */
        .login-info {
            position: relative; /* Cambiado a relative */
            margin-top: auto; /* Empuja el elemento hacia abajo */
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            width: 100%; /* Asegura que ocupe el ancho completo */
            box-sizing: border-box; /* Incluye padding y border en el ancho */
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: white;
            padding: 2px;
        }

        .user-email {
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            color: var(--color-text);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            margin-left: 10px;
        }

        /* Contenido principal */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        .app-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        /* Tareas */
        .tareas-container, .notes-container, .group-members-container {
            background: var(--color-bg-input);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        .tarea-item, .note-item, .member-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease-out;
        }

        .tarea-item:last-child, .note-item:last-child, .member-item:last-child {
            margin-bottom: 0;
        }

        .tarea-info, .note-info, .member-info {
            flex: 1;
        }

        .tarea-title, .note-title, .member-name {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            color: var(--color-text);
        }

        .tarea-prioridad {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .prioridad-alta {
            background-color: #710101;
        }

        .prioridad-normal {
            background-color: #153704;
        }

        .tarea-descripcion, .note-content, .member-email {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
            color: var(--color-text-secondary);
        }

        .tarea-fecha, .note-date {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        .tarea-puntos {
            background: var(--color-accent);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
            color: white;
        }

        .tarea-actions, .note-actions, .member-actions {
            display: flex;
            gap: 10px;
        }

        /* Modernized buttons */
        .tarea-btn, .note-btn, .member-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem; /* Adjust icon size */
        }

        .tarea-btn:hover, .note-btn:hover, .member-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .tarea-btn.completar {
            background: var(--color-success);
        }

        .tarea-btn.completar:hover {
            background: #218838;
        }

        .tarea-btn.eliminar, .note-btn.eliminar, .member-btn.remove {
            background: var(--color-danger);
        }

        .tarea-btn.eliminar:hover, .note-btn.eliminar:hover, .member-btn.remove:hover {
            background: #ff6b81;
        }

        .tarea-btn.editar, .note-btn.editar {
            background: var(--color-warning);
        }

        .tarea-btn.editar:hover, .note-btn.editar:hover {
            background: #e0a800;
        }

        .note-attachments a {
            color: var(--color-dark);
            text-decoration: none;
            margin-right: 10px;
        }

        /* Modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            border: 1px solid var(--color-border);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .form-control.error {
            border-color: var(--color-danger);
            animation: vibrate 0.5s;
        }

        .error-message {
            color: var(--color-danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .tipo-tarea {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tipo-tarea-btn {
            flex: 1;
            padding: 10px;
            background: var(--color-bg-input);
            border: none;
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s;
        }

        .tipo-tarea-btn.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            /* Removed Audiowide from here as per request */
        }

        .btn-primary {
            background: var(--color-accent);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #4f84ff;
            transform: translateY(-2px);
        }

        /* Secci√≥n de tareas completadas */
        .tareas-completadas-container {
            background: var(--color-bg-input);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .tarea-completada {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tarea-completada.entregada {
            background: rgba(40, 167, 69, 0.2);
            text-decoration: line-through;
        }

        .tarea-completada.no-entregada {
            background: rgba(220, 53, 69, 0.2);
            text-decoration: line-through;
        }

        .tarea-completada-info {
            flex: 1;
        }

        .tarea-completada-status {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .entregada-text {
            color: var(--color-success);
        }

        .no-entregada-text {
            color: var(--color-danger);
        }

        /* Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
            /* MODIFICACI√ìN: Ocultar por defecto para evitar parpadeo */
            display: none; 
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            position: relative;
            z-index: 2;
            border: 1px solid var(--color-border);
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            /* Removed Audiowide from here as per request */
            color: var(--color-text);
        }

        .auth-options {
            width: 100%;
            margin-top: 20px;
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            background: #4285F4;
            color: white;
            /* Removed Audiowide from here as per request */
        }

        .login-btn:hover {
            background: #3367D6;
        }

        .login-btn img {
            width: 20px;
            height: 20px;
            background: white;
            padding: 5px;
            border-radius: 50%;
        }

        .skip-btn {
            background: none;
            border: none;
            color: var(--color-text);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px;
            /* Removed Audiowide from here as per request */
        }

        .skip-btn:hover {
            color: #ffffff;
        }

        .terms {
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .terms-link {
            color: var(--color-text);
            text-decoration: none;
        }

        .terms-link:hover {
            text-decoration: underline;
        }

        /* Notificaciones */
        .notificacion {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1001;
            animation: fadeIn 0.3s ease-out;
            /* Removed Audiowide from here as per request */
        }

        /* Configuraci√≥n de notificaciones mejorada */
        .notification-setting {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .notification-setting label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .notification-setting select, 
        .notification-setting input {
            padding: 5px;
            border-radius: 5px;
            background: var(--color-bg-input);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            min-width: 80px;
        }

        .time-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .time-inputs input {
            width: 60px;
            padding: 8px;
            text-align: center;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text);
        }

        .time-inputs span {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }

        @keyframes vibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0; /* Ajustado para que abarque la parte superior */
                left: 0;
                height: 100vh; /* Ajustado para que abarque toda la altura */
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .close-sidebar {
                display: block;
            }

            .menu-btn {
                display: block;
            }
            
            .background-image {
                background-size: 60%;
            }
            
            .notification-setting {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .time-inputs {
                width: 100%;
                justify-content: space-between;
            }

            .fixed-buttons-container {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 10px;
            }

          .settings-item {
            position: relative; /* Cambiamos a relativo para m√≥vil */
        }

        .theme-options, 
        .role-options, 
        .notification-settings {
            position: fixed; /* Fijo en la pantalla */
            top: 50% !important;
            left: 50% !important;
            right: auto !important;
            bottom: auto !important;
            transform: translate(-50%, -50%) !important;
            width: 90%;
            max-width: 280px;
            background: var(--color-primary) !important;
            border: 2px solid var(--color-accent);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            z-index: 2000;
            max-height: 70vh;
            overflow-y: auto;
        }

            .join-group-input {
                flex-direction: column;
                gap: 8px;
            }

            .join-group-input input {
                width: 100%;
                padding: 8px;
            }

            #join-group-btn {
                width: 100%;
                padding: 8px;
                font-size: 0.9rem;
            }
            .group-members-list {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 8px;
                padding: 10px;
                margin-top: 10px;
            }

            .member-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid var(--color-border);
            }

            .member-info {
                text-align: right;
                flex: 1;
            }

            .member-name {
                font-weight: bold;
                font-size: 0.9rem;
            }

            .member-email {
                font-size: 0.75rem;
                color: var(--color-text-secondary);
            }
        }

        /* Temas de color */
        .theme-dark {
            --color-primary: #050916;
            --color-secondary: #0b5657;
            --color-accent: #0d3430;
            --color-light: #ffffff;
            --color-dark: #0080ff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #032711;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-light {
            --color-primary: #f5f5f5;
            --color-secondary: #e0e0e0;
            --color-accent: #4a90e2;
            --color-light: #333333;
            --color-dark: #2c3e50;
            --color-success: #2ecc71;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
            --color-text: #333333;
            --color-text-secondary: rgba(51, 51, 51, 0.7);
            --color-bg-input: rgba(0, 0, 0, 0.05);
            --color-border: rgba(0, 0, 0, 0.1);
        }

        .theme-purple {
            --color-primary: #1a0933;
            --color-secondary: #3d1a68;
            --color-accent: #6a3093;
            --color-light: #ffffff;
            --color-dark: #9b59b6;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-blue {
            --color-primary: #0a192f;
            --color-secondary: #172a45;
            --color-accent: #1e4d8c;
            --color-light: #ffffff;
            --color-dark: #64ffda;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #17a2b8;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-green {
            --color-primary: #0d1f0c;
            --color-secondary: #1a3a1a;
            --color-accent: #2a5e2a;
            --color-light: #ffffff;
            --color-dark: #4caf50;
            --color-success: #2e7d32;
            --color-danger: #c62828;
            --color-warning: #f9a825;
            --color-info: #0277bd;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-red {
            --color-primary: #1a0000;
            --color-secondary: #4a0000;
            --color-accent: #8b0000;
            --color-light: #ffffff;
            --color-dark: #ff4444;
            --color-success: #00c851;
            --color-danger: #ff4444;
            --color-warning: #ffbb33;
            --color-info: #33b5e5;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-midnight {
            --color-primary: #0a0e17;
            --color-secondary: #1a2138;
            --color-accent: #2a3a5e;
            --color-light: #ffffff;
            --color-dark: #6c8ae4;
            --color-success: #00b894;
            --color-danger: #d63031;
            --color-warning: #fdcb6e;
            --color-info: #0984e3;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-ocean {
            --color-primary: #001f3f;
            --color-secondary: #003366;
            --color-accent: #0074d9;
            --color-light: #ffffff;
            --color-dark: #7fdbff;
            --color-success: #2ecc40;
            --color-danger: #ff4136;
            --color-warning: #ffdc00;
            --color-info: #39cccc;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-forest {
            --color-primary: #0d2601;
            --color-secondary: #1a4003;
            --color-accent: #2a6607;
            --color-light: #ffffff;
            --color-dark: #4d9900;
            --color-success: #2e7d32;
            --color-danger: #c62828;
            --color-warning: #f9a825;
            --color-info: #0277bd;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-black-white {
            --color-primary: #000000;
            --color-secondary: #333333;
            --color-accent: #666666;
            --color-light: #ffffff;
            --color-dark: #999999;
            --color-success: #00c851;
            --color-danger: #ff4444;
            --color-warning: #ffbb33;
            --color-info: #2f2f2f;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        /* Fixed buttons container */
        .fixed-buttons-container {
            position: sticky;
            top: var(--header-height); /* Adjust based on header height */
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            gap: 10px;
            z-index: 999;
            border-bottom: 1px solid var(--color-border);
        }

        .fixed-buttons-container button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .fixed-buttons-container button:hover {
            opacity: 0.9;
        }

        .fixed-buttons-container .btn-tarea {
            background: var(--color-accent);
        }

        .fixed-buttons-container .btn-examen {
            background: var(--color-info);
        }

        .fixed-buttons-container .btn-nota {
            background: var(--color-warning);
        }

        /* Role selection modal */
        .role-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1200;
            display: none;
        }

        .role-selection-content {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .role-selection-content h2 {
            margin-bottom: 20px;
            color: var(--color-text);
        }

        .role-selection-content .form-group {
            margin-bottom: 20px;
        }

        .role-selection-content .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .role-selection-content .btn-group button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .role-selection-content .btn-group .btn-teacher {
            background: var(--color-accent);
            color: white;
        }

        .role-selection-content .btn-group .btn-student {
            background: var(--color-secondary);
            color: white;
        }

        .role-selection-content .btn-group button:hover {
            opacity: 0.9;
        }

        /* Group specific styles */
        .group-code-display {
            background: var(--color-bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            word-break: break-all;
            display: flex;
            flex-direction: column; /* Changed to column for better layout */
            justify-content: space-between;
            align-items: flex-start; /* Align items to start */
            gap: 10px; /* Space between elements */
        }

        .group-code-display .code-text {
            font-weight: bold;
            color: var(--color-text);
        }

        .group-code-display .copy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .group-code-display button {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 8px 15px; /* Increased padding */
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem; /* Adjusted font size */
        }

        .copy-url-btn {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .copy-url-btn:hover {
            background: var(--color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .copy-url-btn i {
            font-size: 1rem;
        }

        .group-code-display .info-message {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

       .join-group-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .join-group-input input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: var(--color-bg-input);
            color: var(--color-text);
        }

        .small-join-btn {
            padding: 4px 8px; 
            font-size: 0.8rem; 
            height: auto;
        }

       .join-group-input button {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 0 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .join-group-input button:hover {
            background: var(--color-dark);
        }

        .file-upload-container {
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed var(--color-border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }

        .file-upload-container:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-list {
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
        }

        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-list-item span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-list-item button {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }

        /* Progress bar for file upload */
        .upload-progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        .upload-progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--color-accent);
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Imagen de fondo fija -->
    <div class="background-image"></div>

    <!-- Header superior -->
    <div class="top-header">
        <div class="auth-buttons" id="auth-buttons">
            <img src="googleimg.png" class="google-icon" alt="Google">
            <button class="auth-btn login" id="header-login-btn">Iniciar sesi√≥n</button>
            <button class="auth-btn register" id="header-register-btn">Registrarme</button>
        </div>
    </div>

    <!-- Bot√≥n de configuraci√≥n flotante -->
    <div class="settings-btn-container">
        <button class="settings-btn" id="settings-btn" title="Configuraci√≥n">
            <i class="fas fa-cog settings-icon"></i>
        </button>   
        <div class="settings-menu" id="settings-menu">
            <div class="settings-item" id="change-theme-btn">
                <span>Cambiar tema</span>
                <span>üé®</span>
                <div class="theme-options" id="theme-options">
                    <div class="theme-option" data-theme="dark" style="background: #0d3430; color: white;">Original</div>
                    <div class="theme-option" data-theme="light" style="background: #f5f5f5; color: #333;">Claro</div>
                    <div class="theme-option" data-theme="purple" style="background: #1a0933; color: white;">Morado</div>
                    <div class="theme-option" data-theme="blue" style="background: #0a192f; color: white;">Azul</div>
                    <div class="theme-option" data-theme="green" style="background: #0d1f0c; color: white;">Verde</div>
                    <div class="theme-option" data-theme="red" style="background: #1a0000; color: white;">Rojo</div>
                    <div class="theme-option" data-theme="midnight" style="background: #0a0e17; color: white;">Medianoche</div>
                    <div class="theme-option" data-theme="ocean" style="background: #001f3f; color: white;">Oc√©ano</div>
                    <div class="theme-option" data-theme="forest" style="background: #0d2601; color: white;">Bosque</div>
                    <div class="theme-option" data-theme="black-white" style="background: #000000; color: white;">Blanco y Negro</div>
                </div>
            </div>
            
            <div class="settings-item" id="notification-settings-btn">
                <span>Configurar notificaciones</span>
                <span>üîî</span>
                <div class="notification-settings" id="notification-settings">
                    <div class="notification-setting">
                        <label>Recordatorio tareas normales:</label>
                        <div class="time-inputs">
                            <input type="number" id="reminder-normal-days" min="0" value="1" placeholder="D√≠as">
                            <span>d√≠as </span>
                            <input type="number" id="reminder-normal-hours" min="0" max="23" value="0" placeholder="Horas">
                            <span>horas</span>
                        </div>
                    </div>
                    <div class="notification-setting">
                        <label>Recordatorio alta prioridad:</label>
                        <div class="time-inputs">
                            <input type="number" id="reminder-high-days" min="0" value="3" placeholder="D√≠as">
                            <span>d√≠as </span>
                            <input type="number" id="reminder-high-hours" min="0" max="23" value="0" placeholder="Horas">
                            <span>horas</span>
                        </div>
                    </div>
                    
                    <div class="notification-setting">
                        <label>Recordatorio ex√°menes:</label>
                        <div class="time-inputs">
                            <input type="number" id="reminder-exam-days" min="0" value="2" placeholder="D√≠as">
                            <span>d√≠as </span>
                            <input type="number" id="reminder-exam-hours" min="0" max="23" value="0" placeholder="Horas">
                            <span>horas</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-item" id="change-role-btn">
                <span>Cambiar Rol (Solo para pruebas)</span>
                <span>üé≠</span>
                <div class="role-options" id="role-options">
                    <div class="role-option" data-role="teacher">Maestro</div>
                    <div class="role-option" data-role="student">Alumno</div>
                </div>
            </div>
            
            <div class="settings-item" id="add-google-account">
                <span>Agregar cuenta de Google</span>
                <span>‚ûï</span>
            </div>
            <div class="settings-item logout" id="logout-menu-btn">
                <span>Cerrar sesi√≥n</span>
                <span>üö™</span>
            </div>
            <div class="settings-item delete-account" id="delete-account-btn">
                <span>Eliminar cuenta</span>
                <span>üóëÔ∏è</span>
            </div>
        </div>
    </div>

    <!-- Di√°logo personalizado para confirmaciones -->
    <div class="custom-dialog" id="confirm-dialog">
        <div class="custom-dialog-message" id="confirm-message">¬øEst√°s seguro de que quieres eliminar esta tarea?</div>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-btn cancel" id="confirm-cancel">Cancelar</button>
            <button class="custom-dialog-btn confirm" id="confirm-ok">Eliminar</button>
        </div>
    </div>

    <!-- Di√°logo de confirmaci√≥n para cerrar sesi√≥n -->
    <div class="custom-dialog" id="logout-dialog">
        <div class="custom-dialog-message">¬øEst√°s seguro que quieres cerrar sesi√≥n en esta cuenta?</div>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-btn cancel" id="logout-cancel">Cancelar</button>
            <button class="custom-dialog-btn confirm" id="logout-confirm">Cerrar sesi√≥n</button>
        </div>
    </div>

    <!-- Di√°logo de confirmaci√≥n para eliminar cuenta -->
    <div class="custom-dialog" id="delete-account-dialog">
        <div class="custom-dialog-message">¬øEst√°s seguro que quieres eliminar tu cuenta? Esta acci√≥n es irreversible y borrar√° todos tus datos.</div>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-btn cancel" id="delete-account-cancel">Cancelar</button>
            <button class="custom-dialog-btn confirm" id="delete-account-confirm">Eliminar cuenta</button>
        </div>
    </div>

    <!-- Modal de selecci√≥n de rol y nombre completo -->
    <div class="role-selection-modal" id="role-selection-modal">
        <div class="role-selection-content">
            <h2>¬°Bienvenido!</h2>
            <p>Por favor, dinos tu nombre completo y tu rol:</p>
            <div class="form-group">
                <label for="full-name-input">Nombre Completo</label>
                <input type="text" id="full-name-input" class="form-control" placeholder="Tu nombre completo" required>
                <div class="error-message" id="error-full-name">Este campo es obligatorio</div>
            </div>
            <div class="btn-group">
                <button class="btn-teacher" data-role="teacher" id="select-teacher-role">Soy Maestro</button>
                <button class="btn-student" data-role="student" id="select-student-role">Soy Alumno</button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1 class="login-title">LOUVLE</h1>
            <p>Organiza tus tareas acad√©micas de manera eficiente</p>
            
            <div class="auth-options">
                <button id="google-login" class="login-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
                    Iniciar sesi√≥n con Google
                </button>
                
                <button id="skip-login" class="skip-btn">
                    O continuar sin cuenta
                </button>
                
                <div class="terms">
                    Al continuar, aceptas nuestros <a href="#" class="terms-link">T√©rminos de Servicio</a> y <a href="#" class="terms-link">Pol√≠tica de Privacidad</a>.
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="app-container">
        <!-- Men√∫ lateral -->
        <div class="sidebar" id="sidebar">
            <div class="logo-title">LOUVLE</div>
            
            <!-- Secci√≥n de Materias -->
            <div id="materias-section">
                <div class="sidebar-header">
                    <div class="sidebar-title" id="sidebar-title-materias">Materias</div>
                    <button class="close-sidebar" id="close-sidebar">√ó</button>
                </div>
                <div class="materias-list" id="materias-list"></div>
                <button class="add-materia-btn" id="abrir-modal-materia">+ Nueva Materia</button>
            </div>

            <!-- Secci√≥n de Grupos -->
            <div id="groups-section">
                <div class="sidebar-header" style="margin-top: 20px;">
                    <div class="sidebar-title">Grupos</div>
                </div>
                <div class="groups-list" id="groups-list"></div>
                <div class="join-group-input">
                    <input type="text" id="join-group-code" placeholder="Pega el c√≥digo del grupo">
                    <button id="join-group-btn">‚úî</button>
                </div>
                <button class="add-group-btn" id="abrir-modal-group" style="display: none;">+ Nuevo Grupo</button>
            </div>
            
            <!-- Information about the selected group -->
            <div id="group-details-section" style="display: none; margin-top: 20px;">
                <div class="sidebar-header" style="cursor: pointer;" id="toggle-members-btn">
                    <div class="sidebar-title">Miembros del Grupo <i class="fas fa-chevron-down" id="members-arrow"></i></div>
                </div>
                <div class="group-members-list" id="group-members-list" style="display: none; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- Informaci√≥n de login -->
            <div class="login-info" id="login-info">
                <img id="user-avatar" class="user-avatar" src="" alt="Foto de perfil">
                <div id="user-email" class="user-email"></div>
                <button class="logout-btn" id="logout-btn" title="Cerrar sesi√≥n">‚úï</button>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <div class="header">
                <button class="menu-btn" id="menu-btn">‚ò∞</button>
                <h1 class="app-title">Organizador Acad√©mico</h1>
            </div>

            <!-- Teacher Group Code Display -->
            <div id="teacher-group-code-display" class="group-code-display" style="display: none;">
                <div class="copy-container">
                    <button class="copy-url-btn" id="copy-current-group-code">
                        <i class="fas fa-copy"></i> Copiar C√≥digo de Invitaci√≥n
                    </button>
                    <span class="info-message" id="copy-code-message" style="display: none;">Cualquiera con este c√≥digo puede unirse a su grupo, incluidos los alumnos.</span>
                </div>
            </div>

            <!-- Fixed buttons for adding tasks, exams, notes -->
            <div class="fixed-buttons-container" id="fixed-buttons-container">
                <button class="btn-tarea" id="abrir-modal-tarea">+ Nueva Tarea</button>
                <button class="btn-examen" id="abrir-modal-examen">+ Nuevo Examen</button>
                <button class="btn-nota" id="abrir-modal-nota">+ Nueva Nota</button>
            </div>

            <!-- Tareas pendientes -->
            <div class="tareas-container" id="tareas-pendientes-container">
                <h2 class="section-title" id="titulo-tareas">Tareas Pendientes</h2>
                <div id="lista-tareas-pendientes"></div>
            </div>

            <!-- Ex√°menes pendientes -->
            <div class="tareas-container" id="examenes-pendientes-container">
                <h2 class="section-title">Ex√°menes Pendientes</h2>
                <div id="lista-examenes-pendientes"></div>
            </div>

            <!-- Notas -->
            <div class="notes-container" id="notes-container">
                <h2 class="section-title">Notas</h2>
                <div id="lista-notas"></div>
            </div>

            <!-- Tareas completadas -->
            <div class="tareas-completadas-container" id="tareas-completadas-container">
                <h2 class="section-title">Tareas Completadas</h2>
                <div id="lista-tareas-completadas"></div>
            </div>

            <!-- Ex√°menes completados -->
            <div class="tareas-completadas-container" id="examenes-completados-container">
                <h2 class="section-title">Ex√°menes Realizados</h2>
                <div id="lista-examenes-completados"></div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar materia -->
    <div class="modal" id="modal-materia">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nueva Materia</h2>
                <button class="close-modal" id="cerrar-modal-materia">√ó</button>
            </div>
            <div class="form-group">
                <label for="nombre-materia">Nombre de la materia</label>
                <input type="text" id="nombre-materia" class="form-control" placeholder="Ej: Matem√°ticas" required>
                <div class="error-message" id="error-nombre-materia">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="zona-materia">Puntos de zona</label>
                <input type="number" id="zona-materia" class="form-control" placeholder="Ej: 40" min="1" required>
                <div class="error-message" id="error-zona-materia">Este campo es obligatorio</div>
            </div>
            <button class="btn btn-primary" id="guardar-materia">Guardar</button>
        </div>
    </div>

    <!-- Modal para agregar/editar tarea -->
    <div class="modal" id="modal-tarea">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-tarea-title">Nueva Tarea</h2>
                <button class="close-modal" id="cerrar-modal-tarea">√ó</button>
            </div>
            <div class="form-group">
                <label for="tarea-descripcion">Descripci√≥n</label>
                <input type="text" id="tarea-descripcion" class="form-control" placeholder="Ej: Hacer ejercicios de √°lgebra" required>
                <div class="error-message" id="error-tarea-descripcion">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="tarea-puntos">Puntos</label>
                <input type="number" id="tarea-puntos" class="form-control" placeholder="Ej: 10" min="1" required>
                <div class="error-message" id="error-tarea-puntos">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="tarea-fecha">Fecha de entrega</label>
                <input type="date" id="tarea-fecha" class="form-control" required>
                <div class="error-message" id="error-tarea-fecha">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="tarea-prioridad"> Prioridad alta
                </label>
            </div>
            <div class="form-group" id="tarea-status-group">
                <label>Estado</label>
                <div>
                    <label>
                        <input type="radio" name="tarea-status" value="entregada" checked> Entregada
                    </label>
                    <label>
                        <input type="radio" name="tarea-status" value="no-entregada"> No entregada
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" id="guardar-tarea">Guardar</button>
            <button class="btn btn-primary" id="cancelar-tarea" style="background: var(--color-danger); margin-top: 10px;">Cancelar Tarea</button>
        </div>
    </div>

    <!-- Modal para agregar/editar examen -->
    <div class="modal" id="modal-examen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-examen-title">Nuevo Examen</h2>
                <button class="close-modal" id="cerrar-modal-examen">√ó</button>
            </div>
            <div class="form-group">
                <label for="examen-descripcion">Descripci√≥n</label>
                <input type="text" id="examen-descripcion" class="form-control" placeholder="Ej: Examen parcial de √°lgebra" required>
                <div class="error-message" id="error-examen-descripcion">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-puntos">Puntos</label>
                <input type="number" id="examen-puntos" class="form-control" placeholder="Ej: 30" min="1" required>
                <div class="error-message" id="error-examen-puntos">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-fecha">Fecha del examen</label>
                <input type="date" id="examen-fecha" class="form-control" required>
                <div class="error-message" id="error-examen-fecha">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-utiles">√ötiles necesarios</label>
                <input type="text" id="examen-utiles" class="form-control" placeholder="Ej: Calculadora, cuaderno, libro">
            </div>
            <div class="form-group" id="examen-status-group">
                <label>Estado</label>
                <div>
                    <label>
                        <input type="radio" name="examen-status" value="realizado" checked> Realizado
                    </label>
                    <label>
                        <input type="radio" name="examen-status" value="no-realizado"> No realizado
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" id="guardar-examen">Guardar</button>
        </div>
    </div>

    <!-- Modal para agregar/editar nota -->
    <div class="modal" id="modal-nota">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-nota-title">Nueva Nota</h2>
                <button class="close-modal" id="cerrar-modal-nota">√ó</button>
            </div>
            <div class="form-group">
                <label for="nota-titulo">T√≠tulo</label>
                <input type="text" id="nota-titulo" class="form-control" placeholder="Ej: Recordatorio importante" required>
                <div class="error-message" id="error-nota-titulo">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="nota-contenido">Contenido</label>
                <textarea id="nota-contenido" class="form-control" rows="5" placeholder="Escribe tu nota aqu√≠..."></textarea>
            </div>
            <!-- Se elimina la opci√≥n de adjuntar archivos -->
            <!--
            <div class="form-group">
                <label for="nota-archivos">Adjuntar Archivos</label>
                <div class="file-upload-container" id="file-upload-container">
                    <i class="fas fa-cloud-upload-alt"></i> Arrastra y suelta archivos aqu√≠ o haz clic para seleccionar
                    <input type="file" id="nota-archivos" multiple style="display: none;">
                </div>
                <div class="upload-progress-container" id="upload-progress-container">
                    <div class="upload-progress-bar" id="upload-progress-bar">0%</div>
                </div>
                <div class="file-list" id="nota-file-list"></div>
            </div>
            -->
            <button class="btn btn-primary" id="guardar-nota">Guardar</button>
        </div>
    </div>

    <!-- Modal para crear/editar grupo -->
    <div class="modal" id="modal-group">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-group-title">Nuevo Grupo</h2>
                <button class="close-modal" id="cerrar-modal-group">√ó</button>
            </div>
            <div class="form-group">
                <label for="group-name">Nombre del Grupo</label>
                <input type="text" id="group-name" class="form-control" placeholder="Ej: Grupo de √Ålgebra" required>
                <div class="error-message" id="error-group-name">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="group-description">Descripci√≥n (Opcional)</label>
                <textarea id="group-description" class="form-control" rows="3" placeholder="Una breve descripci√≥n del grupo"></textarea>
            </div>
            <div id="group-code-display-modal" class="group-code-display" style="display: none;">
                <div class="code-text">C√≥digo del Grupo: <span id="generated-group-code"></span></div>
                <div class="copy-container">
                    <button id="copy-group-code">Copiar</button>
                    <span class="info-message" id="group-code-info-message" style="display: none;">Cualquiera con este c√≥digo puede unirse a su grupo, incluidos los alumnos.</span>
                </div>
            </div>
            <button class="btn btn-primary" id="save-group">Guardar</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCjPPKnktrMBmdeOSvus8V5IF4Ce0qEL4Q",
            authDomain: "louvle.firebaseapp.com",
            projectId: "louvle",
            storageBucket: "louvle.appspot.com",
            messagingSenderId: "461018835077",
            appId: "1:461018835077:web:a91eda8324062fd9b161ec",
            measurementId: "G-3W8C962ZG1"
        };

        // Inicializar Firebase con persistencia
        const firebaseApp = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Habilitar persistencia con manejo de errores
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn("Persistencia fall√≥ - M√∫ltiples pesta√±as abiertas o datos antiguos.");
                } else if (err.code == 'unimplemented') {
                    console.warn("Persistencia no soportada en este navegador.");
                } else {
                    console.error("Error al habilitar persistencia:", err);
                }
            });

        // Configurar proveedor de Google
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        // Variables globales
        let materias = [];
        let tareas = []; // Tareas de materias personales y de grupos
        let examenes = []; // Ex√°menes de materias personales y de grupos
        let notes = []; // Notas de materias personales y de grupos
        let groups = []; // Grupos a los que el usuario pertenece
        let materiaSeleccionada = null;
        let groupSeleccionado = null;
        let tareaEditando = null;
        let examenEditando = null;
        let noteEditando = null;
        let groupEditando = null;
        let usuario = null;
        let notificacionesMostradas = []; // Renombrado para evitar conflicto con la funci√≥n Notification
        let usandoFirebase = false;
        let confirmCallback = null;
        let notificationSettings = {
            normal: { days: 1, hours: 0 },
            high: { days: 3, hours: 0 },
            exam: { days: 2, hours: 0 }
        };
        let userRole = null; // 'teacher' or 'student'
        let userFullName = null;
        // let currentFiles = []; // For note attachments - ELIMINADO

       // Elementos del DOM (declarados aqu√≠ para asegurar que est√©n disponibles)
        let loginScreen, appContainer, googleLoginBtn, skipLoginBtn, loginInfo, userAvatar, userEmail, logoutBtn,
            headerLoginBtn, headerRegisterBtn, settingsBtn, settingsMenu, changeThemeBtn, themeOptions,
            notificationSettingsBtn, notificationSettingsMenu, addGoogleAccountBtn, logoutMenuBtn, authButtons,
            confirmDialog, confirmMessage, confirmCancel, confirmOk, logoutDialog, logoutCancel, logoutConfirm,
            deleteAccountBtn, deleteAccountDialog, deleteAccountCancel, deleteAccountConfirm, reminderNormalDays,
            reminderNormalHours, reminderHighDays, reminderHighHours, reminderExamDays, reminderExamHours,
            changeRoleBtn, roleOptions, tituloTareas, btnNuevaTarea, btnNuevoExamen, btnNuevaNota,
            tareasPendientesContainer, examenesPendientesContainer, notesContainer, tareasCompletadasContainer,
            examenesCompletadosContainer, materiasList, listaTareasPendientes, listaExamenesPendientes,
            listaNotas, listaTareasCompletadas, listaExamenesCompletados, sidebar, fixedButtonsContainer,
            roleSelectionModal, fullNameInput, selectTeacherRoleBtn, selectStudentRoleBtn, groupsList,
            abrirModalGroupBtn, joinGroupCodeInput, joinGroupBtn, groupDetailsSection, groupMembersList,
            teacherGroupCodeDisplay, copyCurrentGroupCodeBtn, copyCodeMessage, 
            generatedGroupCode, copyGroupCodeBtnModal, groupCodeInfoMessage, toggleMembersBtn, membersArrow,
            groupCodeDisplayModal;

        // Funci√≥n para obtener todos los elementos del DOM despu√©s de que el documento est√© listo
        function getDOMElements() {
            loginScreen = document.getElementById('login-screen');
            appContainer = document.getElementById('app-container');
            googleLoginBtn = document.getElementById('google-login');
            skipLoginBtn = document.getElementById('skip-login');
            loginInfo = document.getElementById('login-info');
            userAvatar = document.getElementById('user-avatar');
            userEmail = document.getElementById('user-email');
            logoutBtn = document.getElementById('logout-btn');
            headerLoginBtn = document.getElementById('header-login-btn');
            headerRegisterBtn = document.getElementById('header-register-btn');
            settingsBtn = document.getElementById('settings-btn');
            settingsMenu = document.getElementById('settings-menu');
            changeThemeBtn = document.getElementById('change-theme-btn');
            themeOptions = document.getElementById('theme-options');
            notificationSettingsBtn = document.getElementById('notification-settings-btn');
            notificationSettingsMenu = document.getElementById('notification-settings');
            addGoogleAccountBtn = document.getElementById('add-google-account');
            logoutMenuBtn = document.getElementById('logout-menu-btn');
            authButtons = document.getElementById('auth-buttons');
            confirmDialog = document.getElementById('confirm-dialog');
            confirmMessage = document.getElementById('confirm-message');
            confirmCancel = document.getElementById('confirm-cancel');
            confirmOk = document.getElementById('confirm-ok');
            logoutDialog = document.getElementById('logout-dialog');
            logoutCancel = document.getElementById('logout-cancel');
            logoutConfirm = document.getElementById('logout-confirm');
            deleteAccountBtn = document.getElementById('delete-account-btn');
            deleteAccountDialog = document.getElementById('delete-account-dialog');
            deleteAccountCancel = document.getElementById('delete-account-cancel');
            deleteAccountConfirm = document.getElementById('delete-account-confirm');
            reminderNormalDays = document.getElementById('reminder-normal-days');
            reminderNormalHours = document.getElementById('reminder-normal-hours');
            reminderHighDays = document.getElementById('reminder-high-days');
            reminderHighHours = document.getElementById('reminder-high-hours');
            reminderExamDays = document.getElementById('reminder-exam-days');
            reminderExamHours = document.getElementById('reminder-exam-hours');
            changeRoleBtn = document.getElementById('change-role-btn');
            roleOptions = document.getElementById('role-options');

            tituloTareas = document.getElementById('titulo-tareas');
            btnNuevaTarea = document.getElementById('abrir-modal-tarea');
            btnNuevoExamen = document.getElementById('abrir-modal-examen');
            btnNuevaNota = document.getElementById('abrir-modal-nota');
            tareasPendientesContainer = document.getElementById('tareas-pendientes-container');
            examenesPendientesContainer = document.getElementById('examenes-pendientes-container');
            notesContainer = document.getElementById('notes-container');
            tareasCompletadasContainer = document.getElementById('tareas-completadas-container');
            examenesCompletadosContainer = document.getElementById('examenes-completados-container');
            materiasList = document.getElementById('materias-list');
            listaTareasPendientes = document.getElementById('lista-tareas-pendientes');
            listaExamenesPendientes = document.getElementById('lista-examenes-pendientes');
            listaNotas = document.getElementById('lista-notas');
            listaTareasCompletadas = document.getElementById('lista-tareas-completadas');
            listaExamenesCompletados = document.getElementById('lista-examenes-completados');
            sidebar = document.getElementById('sidebar');
            fixedButtonsContainer = document.getElementById('fixed-buttons-container');

            roleSelectionModal = document.getElementById('role-selection-modal');
            fullNameInput = document.getElementById('full-name-input');
            selectTeacherRoleBtn = document.getElementById('select-teacher-role');
            selectStudentRoleBtn = document.getElementById('select-student-role');

            groupsList = document.getElementById('groups-list');
            abrirModalGroupBtn = document.getElementById('abrir-modal-group');
            joinGroupCodeInput = document.getElementById('join-group-code'); 
            joinGroupBtn = document.getElementById('join-group-btn'); 
           groupDetailsSection = document.getElementById('group-details-section');
            groupMembersList = document.getElementById('group-members-list');
            teacherGroupCodeDisplay = document.getElementById('teacher-group-code-display'); 
            copyCurrentGroupCodeBtn = document.getElementById('copy-current-group-code'); 
            copyCodeMessage = document.getElementById('copy-code-message'); 
            generatedGroupCode = document.getElementById('generated-group-code');
            copyGroupCodeBtnModal = document.getElementById('copy-group-code'); 
            groupCodeInfoMessage = document.getElementById('group-code-info-message');
            groupCodeDisplayModal = document.getElementById('group-code-display-modal'); 
            toggleMembersBtn = document.getElementById('toggle-members-btn'); // Get the toggle button
            membersArrow = document.getElementById('members-arrow'); // Get the arrow icon
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            getDOMElements(); // Obtener todos los elementos del DOM
            
            // Ocultar elementos que no deben mostrarse al inicio
            if (appContainer) appContainer.style.display = 'none';
            if (loginInfo) loginInfo.style.display = 'none';
            if (tareasPendientesContainer) tareasPendientesContainer.style.display = 'none';
            if (examenesPendientesContainer) examenesPendientesContainer.style.display = 'none';
            if (notesContainer) notesContainer.style.display = 'none';
            if (tareasCompletadasContainer) tareasCompletadasContainer.style.display = 'none';
            if (examenesCompletadosContainer) examenesCompletadosContainer.style.display = 'none';
            if (fixedButtonsContainer) fixedButtonsContainer.style.display = 'none';
            if (document.getElementById('tarea-status-group')) document.getElementById('tarea-status-group').style.display = 'none';
            if (document.getElementById('examen-status-group')) document.getElementById('examen-status-group').style.display = 'none';
            if (document.getElementById('cancelar-tarea')) document.getElementById('cancelar-tarea').style.display = 'none';
            if (groupDetailsSection) groupDetailsSection.style.display = 'none';
            if (teacherGroupCodeDisplay) teacherGroupCodeDisplay.style.display = 'none'; 
            
            // Configurar eventos
            configurarEventos();
            configurarServiceWorker();
            
            // Verificar sesi√≥n y cargar datos
            verificarSesion();
            
            // Solicitar permisos para notificaciones
            solicitarPermisosNotificaciones();

            // Handle group join code from localStorage (if user was redirected after login)
            handlePendingGroupJoinCode();
        });

       function handlePendingGroupJoinCode() {
    const pendingGroupJoinCode = localStorage.getItem('pendingGroupJoinCode');
    if (pendingGroupJoinCode) {
        localStorage.removeItem('pendingGroupJoinCode');
        if (usuario && usuario.uid) { // Only join if user is already logged in
            joinGroup(pendingGroupJoinCode);
        }
    }
}

        function solicitarPermisosNotificaciones() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        mostrarNotificacion('Notificaciones activadas');
                    }
                });
            }
        }

        function configurarEventos() {
            // Eventos de autenticaci√≥n
            if (googleLoginBtn) googleLoginBtn.addEventListener('click', iniciarSesionGoogle);
            if (skipLoginBtn) skipLoginBtn.addEventListener('click', usarLocalStorage);
            if (logoutBtn) logoutBtn.addEventListener('click', mostrarLogoutDialog);
            if (headerLoginBtn) headerLoginBtn.addEventListener('click', mostrarLoginScreen);
            if (headerRegisterBtn) headerRegisterBtn.addEventListener('click', mostrarLoginScreen);
            if (logoutMenuBtn) logoutMenuBtn.addEventListener('click', mostrarLogoutDialog);
            if (addGoogleAccountBtn) addGoogleAccountBtn.addEventListener('click', iniciarSesionGoogle);
            if (logoutCancel) logoutCancel.addEventListener('click', () => logoutDialog.classList.remove('active'));
            if (logoutConfirm) logoutConfirm.addEventListener('click', cerrarSesion);
            if (deleteAccountBtn) deleteAccountBtn.addEventListener('click', () => deleteAccountDialog.classList.add('active'));
            if (deleteAccountCancel) deleteAccountCancel.addEventListener('click', () => deleteAccountDialog.classList.remove('active'));
            if (deleteAccountConfirm) deleteAccountConfirm.addEventListener('click', eliminarCuenta);
            
            document.querySelectorAll('#notification-settings input').forEach(input => {
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });

            // Role selection modal events
            if (selectTeacherRoleBtn) selectTeacherRoleBtn.addEventListener('click', () => selectRole('teacher'));
            if (selectStudentRoleBtn) selectStudentRoleBtn.addEventListener('click', () => selectRole('student'));

            // Eventos de configuraci√≥n
            if (settingsBtn) settingsBtn.addEventListener('click', toggleSettingsMenu);
            if (changeThemeBtn) changeThemeBtn.addEventListener('click', toggleThemeOptions);
            if (notificationSettingsBtn) notificationSettingsBtn.addEventListener('click', toggleNotificationSettings);
            if (changeRoleBtn) changeRoleBtn.addEventListener('click', toggleRoleOptions);
            
            // Configurar eventos de temas
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que el clic cierre el men√∫ principal
                    const theme = option.dataset.theme;
                    cambiarTema(theme);
                });
            });

            // Configurar eventos de rol (solo para pruebas)
            document.querySelectorAll('.role-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que el clic cierre el men√∫ principal
                    const role = option.dataset.role;
                    if (usuario && usuario.uid) {
                        updateUserRole(usuario.uid, role);
                    } else {
                        userRole = role;
                        mostrarNotificacion(`Rol cambiado a ${role} (solo localmente)`);
                        renderizarUIporRol();
                    }
                });
            });

            // Eventos del di√°logo de confirmaci√≥n
            if (confirmCancel) confirmCancel.addEventListener('click', () => {
                confirmDialog.classList.remove('active');
            });
            
            if (confirmOk) confirmOk.addEventListener('click', () => {
                confirmDialog.classList.remove('active');
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
            });

             // Configurar eventos de notificaciones
            if (reminderNormalDays) reminderNormalDays.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            if (reminderNormalHours) reminderNormalHours.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            if (reminderHighDays) reminderHighDays.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            if (reminderHighHours) reminderHighHours.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            if (reminderExamDays) reminderExamDays.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            if (reminderExamHours) reminderExamHours.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            
            // Cerrar men√∫ de configuraci√≥n al hacer clic fuera, pero no si el clic es dentro de un submen√∫
            document.addEventListener('click', (e) => {
                const isClickInsideSettingsMenu = settingsMenu && settingsMenu.contains(e.target);
                const isClickInsideSettingsBtn = settingsBtn && settingsBtn.contains(e.target);
                const isClickInsideNotificationSettings = notificationSettingsMenu && notificationSettingsMenu.contains(e.target);
                const isClickInsideThemeOptions = themeOptions && themeOptions.contains(e.target);
                const isClickInsideRoleOptions = roleOptions && roleOptions.contains(e.target);

                // Close settings menu if click is outside the button and the menu itself
                if (!isClickInsideSettingsBtn && !isClickInsideSettingsMenu) {
                    if (settingsMenu) settingsMenu.classList.remove('active');
                    if (themeOptions) themeOptions.classList.remove('active');
                    if (roleOptions) roleOptions.classList.remove('active');
                    // Only close notification settings if the click is outside its specific area
                    if (!isClickInsideNotificationSettings && notificationSettingsMenu) {
                        notificationSettingsMenu.classList.remove('active');
                    }
                }
            });


            // Eventos de materias
            if (document.getElementById('abrir-modal-materia')) document.getElementById('abrir-modal-materia').addEventListener('click', () => {
                document.getElementById('modal-materia').dataset.mode = 'add';
                document.getElementById('modal-materia').querySelector('.modal-title').textContent = 'Nueva Materia';
                document.getElementById('nombre-materia').value = '';
                document.getElementById('zona-materia').value = '';
                abrirModal('modal-materia');
            });
            if (document.getElementById('cerrar-modal-materia')) document.getElementById('cerrar-modal-materia').addEventListener('click', () => cerrarModal('modal-materia'));
            if (document.getElementById('guardar-materia')) document.getElementById('guardar-materia').addEventListener('click', guardarMateria);
            
            // Configurar eventos del sidebar
            const menuBtn = document.getElementById('menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            
            if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);
            if (closeSidebarBtn) closeSidebarBtn.addEventListener('click', toggleSidebar);
            
            // Eventos de Tareas
            if (btnNuevaTarea) btnNuevaTarea.addEventListener('click', () => {
                if (!materiaSeleccionada && !groupSeleccionado) {
                    mostrarNotificacion('Selecciona una materia o un grupo primero.');
                    return;
                }
                tareaEditando = null;
                document.getElementById('modal-tarea-title').textContent = 'Nueva Tarea';
                document.getElementById('tarea-status-group').style.display = 'none';
                document.getElementById('cancelar-tarea').style.display = 'none';
                // Limpiar formulario
                document.getElementById('tarea-descripcion').value = '';
                document.getElementById('tarea-puntos').value = '';
                document.getElementById('tarea-fecha').value = '';
                document.getElementById('tarea-prioridad').checked = false;
                abrirModal('modal-tarea');
            });
            
            if (document.getElementById('cerrar-modal-tarea')) document.getElementById('cerrar-modal-tarea').addEventListener('click', () => cerrarModal('modal-tarea'));
            if (document.getElementById('guardar-tarea')) document.getElementById('guardar-tarea').addEventListener('click', guardarTarea);
            if (document.getElementById('cancelar-tarea')) document.getElementById('cancelar-tarea').addEventListener('click', cancelarTarea);
            
            // Eventos de Ex√°menes
            if (btnNuevoExamen) btnNuevoExamen.addEventListener('click', () => {
                if (!materiaSeleccionada && !groupSeleccionado) {
                    mostrarNotificacion('Selecciona una materia o un grupo primero.');
                    return;
                }
                examenEditando = null;
                document.getElementById('modal-examen-title').textContent = 'Nuevo Examen';
                document.getElementById('examen-status-group').style.display = 'none';
                // Limpiar formulario
                document.getElementById('examen-descripcion').value = '';
                document.getElementById('examen-puntos').value = '';
                document.getElementById('examen-fecha').value = '';
                document.getElementById('examen-utiles').value = '';
                abrirModal('modal-examen');
            });
            
            if (document.getElementById('cerrar-modal-examen')) document.getElementById('cerrar-modal-examen').addEventListener('click', () => cerrarModal('modal-examen'));
            if (document.getElementById('guardar-examen')) document.getElementById('guardar-examen').addEventListener('click', guardarExamen);

            // Eventos de Notas
            if (btnNuevaNota) btnNuevaNota.addEventListener('click', () => {
                if (!materiaSeleccionada && !groupSeleccionado) {
                    mostrarNotificacion('Selecciona una materia o un grupo primero.');
                    return;
                }
                noteEditando = null;
                document.getElementById('modal-nota-title').textContent = 'Nueva Nota';
                document.getElementById('nota-titulo').value = '';
                document.getElementById('nota-contenido').value = '';
                // currentFiles = []; // ELIMINADO
                // renderNoteFiles(); // ELIMINADO
                // if (uploadProgressContainer) uploadProgressContainer.style.display = 'none'; // Hide progress bar // ELIMINADO
                // if (uploadProgressBar) { // ELIMINADO
                //     uploadProgressBar.style.width = '0%'; // ELIMINADO
                //     uploadProgressBar.textContent = '0%'; // ELIMINADO
                // } // ELIMINADO
                abrirModal('modal-nota');
            });
            if (document.getElementById('cerrar-modal-nota')) document.getElementById('cerrar-modal-nota').addEventListener('click', () => cerrarModal('modal-nota'));
            if (document.getElementById('guardar-nota')) document.getElementById('guardar-nota').addEventListener('click', guardarNota);
            // if (notaFileUploadContainer) notaFileUploadContainer.addEventListener('click', () => notaArchivosInput.click()); // ELIMINADO
            // if (notaArchivosInput) notaArchivosInput.addEventListener('change', handleNoteFileSelect); // ELIMINADO
            // if (notaFileUploadContainer) { // ELIMINADO
            //     notaFileUploadContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); notaFileUploadContainer.classList.add('dragover'); }); // ELIMINADO
            //     notaFileUploadContainer.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); notaFileUploadContainer.classList.remove('dragover'); }); // ELIMINADO
            //     notaFileUploadContainer.addEventListener('drop', handleNoteFileDrop); // ELIMINADO
            // } // ELIMINADO

            // Eventos de Grupos
            if (abrirModalGroupBtn) abrirModalGroupBtn.addEventListener('click', () => {
                if (userRole !== 'teacher') {
                    mostrarNotificacion('Solo los maestros pueden crear grupos.');
                    return;
                }
                document.getElementById('modal-group').dataset.mode = 'add';
                document.getElementById('modal-group-title').textContent = 'Nuevo Grupo';
                document.getElementById('group-name').value = '';
                document.getElementById('group-description').value = '';
                if (groupCodeDisplayModal) groupCodeDisplayModal.style.display = 'none';
                groupEditando = null;
                abrirModal('modal-group');
            });
            if (document.getElementById('cerrar-modal-group')) document.getElementById('cerrar-modal-group').addEventListener('click', () => cerrarModal('modal-group'));
            if (document.getElementById('save-group')) document.getElementById('save-group').addEventListener('click', guardarGrupo);
            if (copyGroupCodeBtnModal) copyGroupCodeBtnModal.addEventListener('click', copyGroupCode); 
            if (joinGroupBtn) joinGroupBtn.addEventListener('click', () => joinGroup(joinGroupCodeInput.value.trim()));
            if (copyCurrentGroupCodeBtn) copyCurrentGroupCodeBtn.addEventListener('click', copyCurrentGroupCode); 

            // Add event listener for 'Enter' key on join-group-code input
            if (joinGroupCodeInput) joinGroupCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    joinGroup(joinGroupCodeInput.value.trim());
                }
            });
            
            // Cargar tema guardado
            const savedTheme = localStorage.getItem('theme') || 'dark';
            cambiarTema(savedTheme);
            
            // Cargar configuraci√≥n de notificaciones
            cargarConfiguracion();

            // Limit year input to 4 characters
            if (document.getElementById('tarea-fecha')) document.getElementById('tarea-fecha').addEventListener('input', (e) => {
                const year = e.target.value.split('-')[0];
                if (year && year.length > 4) {
                    e.target.value = e.target.value.replace(year, year.substring(0, 4));
                }
            });
            if (document.getElementById('examen-fecha')) document.getElementById('examen-fecha').addEventListener('input', (e) => {
                const year = e.target.value.split('-')[0];
                if (year && year.length > 4) {
                    e.target.value = e.target.value.replace(year, year.substring(0, 4));
                }
            });

           // Toggle group members list
            if (toggleMembersBtn) {
                toggleMembersBtn.addEventListener('click', function() {
                    if (groupMembersList && membersArrow) {
                        if (groupMembersList.style.display === 'none' || groupMembersList.style.display === '') {
                            groupMembersList.style.display = 'block';
                            membersArrow.classList.remove('fa-chevron-down');
                            membersArrow.classList.add('fa-chevron-up');
                        } else {
                            groupMembersList.style.display = 'none';
                            membersArrow.classList.remove('fa-chevron-up');
                            membersArrow.classList.add('fa-chevron-down');
                        }
                    }
                });
            }
        }

        function actualizarConfiguracionNotificaciones() {
            notificationSettings = {
                normal: {
                    days: parseInt(reminderNormalDays.value) || 0,
                    hours: parseInt(reminderNormalHours.value) || 0
                },
                high: {
                    days: parseInt(reminderHighDays.value) || 0,
                    hours: parseInt(reminderHighHours.value) || 0
                },
                exam: {
                    days: parseInt(reminderExamDays.value) || 0,
                    hours: parseInt(reminderExamHours.value) || 0
                }
            };
            guardarConfiguracion();
        }

        function cambiarTema(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('theme', theme);
            
            // Marcar el tema activo
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                }
            });
            
            // Actualizar el texto de configuraci√≥n
            if (settingsBtn) {
                settingsBtn.setAttribute('data-theme', theme);
                settingsBtn.style.setProperty('--theme-color', `var(--color-accent)`);
            }

            // Ajuste para el padding-top del app-container despu√©s de iniciar sesi√≥n
            if (document.body.classList.contains('logged-in') && appContainer) {
                appContainer.style.paddingTop = '0';
            } else if (appContainer) {
                appContainer.style.paddingTop = 'var(--header-height)';
            }
        }

        function cargarConfiguracion() {
            const savedSettings = localStorage.getItem('notificationSettings');
            if (savedSettings) {
                notificationSettings = JSON.parse(savedSettings);
                if (reminderNormalDays) reminderNormalDays.value = notificationSettings.normal.days || 1;
                if (reminderNormalHours) reminderNormalHours.value = notificationSettings.normal.hours || 0;
                if (reminderHighDays) reminderHighDays.value = notificationSettings.high.days || 3;
                if (reminderHighHours) reminderHighHours.value = notificationSettings.high.hours || 0;
                if (reminderExamDays) reminderExamDays.value = notificationSettings.exam.days || 2;
                if (reminderExamHours) reminderExamHours.value = notificationSettings.exam.hours || 0;
            }
        }

        function guardarConfiguracion() {
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
        }

        function toggleSettingsMenu(e) {
            e.stopPropagation();
            if (settingsMenu) settingsMenu.classList.toggle('active');
            // Ajustar la posici√≥n de los submen√∫s para que aparezcan desde arriba
            if (settingsMenu && settingsMenu.classList.contains('active')) {
                const settingsItems = settingsMenu.querySelectorAll('.settings-item');
                settingsItems.forEach(item => {
                    const subMenu = item.querySelector('.theme-options, .role-options, .notification-settings');
                    if (subMenu) {
                        subMenu.style.bottom = 'auto'; 
                        subMenu.style.top = '0'; 
                    }
                });
            } else {
                // Close all sub-menus when main menu closes
                if (themeOptions) themeOptions.classList.remove('active');
                if (notificationSettingsMenu) notificationSettingsMenu.classList.remove('active');
                if (roleOptions) roleOptions.classList.remove('active');
            }
            
            // Configurar el texto que aparece al pasar el mouse
            if (settingsMenu && settingsMenu.classList.contains('active') && settingsBtn) {
                settingsBtn.setAttribute('data-text', 'Configuraci√≥n');
            } else if (settingsBtn) {
                settingsBtn.setAttribute('data-text', '');
            }
        }

        function toggleThemeOptions(e) {
            e.stopPropagation();
            if (themeOptions) themeOptions.classList.toggle('active');
            if (themeOptions && themeOptions.classList.contains('active')) {
                if (notificationSettingsMenu) notificationSettingsMenu.classList.remove('active');
                if (roleOptions) roleOptions.classList.remove('active');
            }
        }

        function toggleNotificationSettings(e) {
            e.stopPropagation();
            e.preventDefault(); // A√±adimos esto para prevenir el comportamiento por defecto
            if (notificationSettingsMenu) notificationSettingsMenu.classList.toggle('active');
            if (notificationSettingsMenu && notificationSettingsMenu.classList.contains('active')) {
                if (themeOptions) themeOptions.classList.remove('active');
                if (roleOptions) roleOptions.classList.remove('active');
            }
        }

        function toggleRoleOptions(e) {
            e.stopPropagation();
            if (roleOptions) roleOptions.classList.toggle('active');
            if (roleOptions && roleOptions.classList.contains('active')) {
                if (themeOptions) themeOptions.classList.remove('active');
                if (notificationSettingsMenu) notificationSettingsMenu.classList.remove('active');
            }
        }

        function mostrarLoginScreen() {
            if (loginScreen) loginScreen.style.display = 'flex';
            if (appContainer) appContainer.style.display = 'none';
            if (authButtons) authButtons.style.display = 'flex';
            document.body.classList.remove('logged-in'); // Asegura que la clase se remueva
            const topHeader = document.querySelector('.top-header');
            if (topHeader) topHeader.style.display = 'flex'; // Asegura que la cabecera sea visible
            if (appContainer) appContainer.style.paddingTop = 'var(--header-height)'; // Restablece el padding
        }

        function mostrarLogoutDialog() {
            if (logoutDialog) logoutDialog.classList.add('active');
        }

        function showConfirm(message, callback) {
            if (confirmMessage) confirmMessage.textContent = message;
            confirmCallback = callback;
            if (confirmDialog) confirmDialog.classList.add('active');
        }

        // Funci√≥n para iniciar sesi√≥n con Google
        function iniciarSesionGoogle() {
            auth.signInWithPopup(googleProvider)
                .then((result) => {
                    if (!result.user) {
                        console.error("No user object in result.");
                        return;
                    }
                    // Check if user data exists in Firestore
                    db.collection('usuarios').doc(result.user.uid).get().then(doc => {
                        if (!doc.exists) {
                            // New user, ask for full name and role
                            usuario = {
                                uid: result.user.uid,
                                email: result.user.email,
                                foto: result.user.photoURL || 'https://i.imgur.com/8Km9tLL.png'
                            };
                            if (roleSelectionModal) roleSelectionModal.style.display = 'flex';
                        } else {
                            // Existing user, load data
                            const userData = doc.data();
                            userRole = userData.role;
                            userFullName = userData.fullName;
                            handleUserLogin(result.user);
                        }
                    }).catch(error => {
                        console.error('Error al obtener perfil de usuario:', error);
                        mostrarNotificacion('Error al cargar perfil de usuario.');
                    });
                })
                .catch(error => {
                    console.error('Error al iniciar sesi√≥n con Google:', error);
                    mostrarNotificacion('Error al iniciar sesi√≥n con Google.');
                });
        }

        function selectRole(role) {
            const fullName = fullNameInput ? fullNameInput.value.trim() : '';
            if (!fullName) {
                mostrarError('full-name-input', 'error-full-name');
                return;
            }

            userRole = role;
            userFullName = fullName;
            if (roleSelectionModal) roleSelectionModal.style.display = 'none';

            // Save user data to Firestore
            crearPerfilUsuario(usuario.uid, usuario.email, usuario.foto, userRole, userFullName)
                .then(() => {
                    handleUserLogin(auth.currentUser); // Re-trigger login flow with full data
                })
                .catch(error => {
                    console.error("Error creating user profile:", error);
                    mostrarNotificacion("Error al crear perfil de usuario.");
                });
        }

        // Funci√≥n para usar sin autenticaci√≥n
        function usarLocalStorage() {
            usuario = {
                uid: 'local-user-' + Date.now(),
                nombre: "Usuario Local",
                email: "local@example.com",
                foto: "https://i.imgur.com/8Km9tLL.png",
                local: true
            };
            userRole = 'student'; // Default role for local user
            userFullName = "Usuario Local";
            
            localStorage.setItem('usuario', JSON.stringify(usuario));
            localStorage.setItem('userRole', userRole);
            localStorage.setItem('userFullName', userFullName);
            usandoFirebase = false;
            
            // Ocultar informaci√≥n de login
            if (loginInfo) loginInfo.style.display = 'none';
            
            // Mostrar la aplicaci√≥n
            if (loginScreen) loginScreen.style.display = 'none';
            if (appContainer) appContainer.style.display = 'flex';
            
            // Mostrar botones de autenticaci√≥n en el header
            if (authButtons) authButtons.style.display = 'flex';
            document.body.classList.remove('logged-in'); // Asegura que la clase se remueva
            const topHeader = document.querySelector('.top-header');
            if (topHeader) topHeader.style.display = 'flex'; // Asegura que la cabecera sea visible
            if (appContainer) appContainer.style.paddingTop = 'var(--header-height)'; // Restablece el padding
            
            // Cargar datos locales
            cargarDatosLocales();
            renderizarUIporRol();
            
            mostrarNotificacion('Modo local activado - Los datos no se sincronizar√°n');
        }

        // Funci√≥n para verificar la sesi√≥n al cargar
        function verificarSesion() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is logged in, fetch their role and full name
                    db.collection('usuarios').doc(user.uid).get().then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            userRole = userData.role;
                            userFullName = userData.fullName;
                            handleUserLogin(user);
                        } else {
                            // User logged in but no profile data (should not happen if role selection worked)
                            // Fallback: ask for role and full name
                            usuario = {
                                uid: user.uid,
                                email: user.email,
                                foto: user.photoURL || 'https://i.imgur.com/8Km9tLL.png'
                            };
                            if (roleSelectionModal) roleSelectionModal.style.display = 'flex';
                        }
                    }).catch(error => {
                        console.error("Error fetching user profile:", error);
                        handleUserLogout(); // Treat as logout on error
                    });
                } else {
                    // No user logged in
                    handleUserLogout();
                }
            });
        }

        function handleUserLogin(user) {
            usuario = {
                uid: user.uid,
                nombre: userFullName || user.displayName || (user.email ? user.email.split('@')[0] : 'Usuario'),
                email: user.email,
                foto: user.photoURL || 'https://i.imgur.com/8Km9tLL.png'
            };
            
            document.body.classList.add('logged-in'); // A√±ade la clase al body
            const topHeader = document.querySelector('.top-header');
            if (topHeader) topHeader.style.display = 'none'; // Oculta la cabecera
            if (appContainer) appContainer.style.paddingTop = '0'; // Ajusta el padding a 0
            
            // Mostrar informaci√≥n de usuario
            if (userAvatar) userAvatar.src = usuario.foto;
            if (userEmail) userEmail.textContent = usuario.email;
            if (loginInfo) loginInfo.style.display = 'flex';
            
            // Ocultar botones de autenticaci√≥n en el header
            if (authButtons) authButtons.style.display = 'none';
            
            // Guardar datos de sesi√≥n
            localStorage.setItem('usuario', JSON.stringify(usuario));
            localStorage.setItem('userRole', userRole);
            localStorage.setItem('userFullName', userFullName);
            usandoFirebase = true;
            
            // Cargar datos de Firestore
            cargarDatosFirebase();
            
            // Mostrar la aplicaci√≥n
            if (loginScreen) loginScreen.style.display = 'none';
            if (appContainer) appContainer.style.display = 'flex';
            renderizarUIporRol();

            // Check for pending group join
            handlePendingGroupJoinCode();
        }

        function handleUserLogout() {
            // Verificar si hay datos locales
            const usuarioLocal = JSON.parse(localStorage.getItem('usuario'));
            const localRole = localStorage.getItem('userRole');
            const localFullName = localStorage.getItem('userFullName');
            
            document.body.classList.remove('logged-in'); // Remueve la clase del body
            const topHeader = document.querySelector('.top-header');
            if (topHeader) topHeader.style.display = 'flex'; // Muestra la cabecera
            if (appContainer) appContainer.style.paddingTop = 'var(--header-height)'; // Restablece el padding

            if (usuarioLocal && usuarioLocal.local) {
                // Usuario local
                usuario = usuarioLocal;
                userRole = localRole;
                userFullName = localFullName;
                usandoFirebase = false;
                if (loginInfo) loginInfo.style.display = 'none';
                if (authButtons) authButtons.style.display = 'flex';
                cargarDatosLocales();
                if (loginScreen) loginScreen.style.display = 'none';
                if (appContainer) appContainer.style.display = 'flex';
                renderizarUIporRol();
            } else {
                // No hay usuario local ni autenticado
                if (loginScreen) loginScreen.style.display = 'flex';
                if (appContainer) appContainer.style.display = 'none';
                if (authButtons) authButtons.style.display = 'flex';
                usuario = null;
                userRole = null;
                userFullName = null;
                // Clear all local storage related to user data
                localStorage.removeItem('usuario');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userFullName');
                localStorage.removeItem('materias');
                localStorage.removeItem('tareas');
                localStorage.removeItem('examenes');
                localStorage.removeItem('notes');
                localStorage.removeItem('groups');
                localStorage.removeItem('notificationSettings');
                localStorage.removeItem('theme');
            }
        }

        async function crearPerfilUsuario(uid, email, photoURL, role, fullName) {
            try {
                await db.collection('usuarios').doc(uid).set({
                    fullName: fullName,
                    email: email,
                    photoURL: photoURL || '',
                    role: role,
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp(),
                    configuracion: {
                        tema: 'dark',
                        notificaciones: true
                    }
                });
                console.log("Perfil de usuario creado/actualizado");
            } catch (error) {
                console.error("Error al crear/actualizar perfil:", error);
                throw error; // Re-throw to be caught by the caller
            }
        }

        async function updateUserRole(uid, newRole) {
            try {
                await db.collection('usuarios').doc(uid).update({
                    role: newRole,
                    ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp()
                });
                userRole = newRole;
                mostrarNotificacion(`Tu rol ha sido cambiado a ${newRole}`);
                renderizarUIporRol();
            } catch (error) {
                console.error("Error updating user role:", error);
                mostrarNotificacion("Error al actualizar el rol.");
            }
        }

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            auth.signOut().then(() => {
                // Limpiar solo la informaci√≥n de autenticaci√≥n, no los datos
                usuario = null;
                materiaSeleccionada = null;
                groupSeleccionado = null;
                
                if (logoutDialog) logoutDialog.classList.remove('active');
                
                // Verificar si hay datos locales
                handleUserLogout();
                
                mostrarNotificacion('Sesi√≥n cerrada correctamente');
            }).catch(error => {
                console.error('Error al cerrar sesi√≥n:', error);
                mostrarNotificacion('Error al cerrar sesi√≥n.');
            });
        }

        async function eliminarCuenta() {
            if (deleteAccountDialog) deleteAccountDialog.classList.remove('active');
            if (!usuario || !usuario.uid) {
                mostrarNotificacion('No hay usuario para eliminar.');
                return;
            }

            try {
                // 1. Eliminar datos del usuario en Firestore
                const userDocRef = db.collection('usuarios').doc(usuario.uid);
                const collectionsToDelete = ['materias', 'tareas', 'examenes', 'notes'];

                for (const collectionName of collectionsToDelete) {
                    const snapshot = await userDocRef.collection(collectionName).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                await userDocRef.delete();

                // 2. Eliminar archivos del Storage (opcional, si hay muchos archivos, puede ser lento)
                // const storageRef = storage.ref(`notes/${usuario.uid}`); // ELIMINADO
                // try { // ELIMINADO
                //     const listResult = await storageRef.listAll(); // ELIMINADO
                //     for (const item of listResult.items) { // ELIMINADO
                //         await item.delete(); // ELIMINADO
                //     } // ELIMINADO
                // } catch (storageError) { // ELIMINADO
                //     if (storageError.code === 'storage/object-not-found') { // ELIMINADO
                //         console.log("No hay archivos en Storage para este usuario."); // ELIMINADO
                //     } else { // ELIMINADO
                //         console.warn(`Error al listar/eliminar archivos del Storage para ${usuario.uid}:`, storageError); // ELIMINADO
                //     } // ELIMINADO
                // } // ELIMINADO

                // 3. Eliminar al usuario de los grupos donde sea miembro
                const groupsSnapshot = await db.collection('groups').where('members', 'array-contains', usuario.uid).get();
                for (const groupDoc of groupsSnapshot.docs) {
                    const groupData = groupDoc.data();
                    if (groupData.ownerId === usuario.uid) {
                        // If the user is the owner, delete the entire group
                        await db.collection('groups').doc(groupDoc.id).delete();
                    } else {
                        // If not the owner, just remove the user from members
                        await db.collection('groups').doc(groupDoc.id).update({
                            members: firebase.firestore.FieldValue.arrayRemove(usuario.uid)
                        });
                    }
                }

                // 4. Eliminar la cuenta de autenticaci√≥n
                await auth.currentUser.delete();

                mostrarNotificacion('Tu cuenta y todos tus datos han sido eliminados.');
                handleUserLogout(); // Reset UI after deletion
            } catch (error) {
                console.error('Error al eliminar la cuenta:', error);
                if (error.code === 'auth/requires-recent-login') {
                    mostrarNotificacion('Por favor, vuelve a iniciar sesi√≥n para eliminar tu cuenta por seguridad.');
                    await auth.signOut(); // Force re-login
                    handleUserLogout();
                } else {
                    mostrarNotificacion('Error al eliminar la cuenta. Int√©ntalo de nuevo.');
                }
            }
        }

        function cargarDatosFirebase() {
            if (!usuario || !usuario.uid) return;
            
            // Materias (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('materias')
                .onSnapshot(snapshot => {
                    materias = [];
                    snapshot.forEach(doc => {
                        materias.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarMaterias();
                    guardarDatosLocales(); // Guardar cach√© local
                }, error => {
                    console.error('Error al cargar materias:', error);
                    // No cargar datos locales aqu√≠, ya que onSnapshot se encarga de la sincronizaci√≥n
                });

            // Tareas (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('tareas')
                .onSnapshot(snapshot => {
                    tareas = [];
                    snapshot.forEach(doc => {
                        tareas.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarTareasPendientes();
                    renderizarTareasCompletadas();
                    guardarDatosLocales();
                    verificarRecordatorios();
                }, error => {
                    console.error('Error al cargar tareas:', error);
                });

            // Ex√°menes (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('examenes')
                .onSnapshot(snapshot => {
                    examenes = [];
                    snapshot.forEach(doc => {
                        examenes.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarExamenesPendientes();
                    renderizarExamenesCompletados();
                    guardarDatosLocales();
                    verificarRecordatorios();
                }, error => {
                    console.error('Error al cargar ex√°menes:', error);
                });

            // Notas (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('notes')
                .onSnapshot(snapshot => {
                    notes = [];
                    snapshot.forEach(doc => {
                        notes.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarNotas();
                    guardarDatosLocales();
                }, error => {
                    console.error('Error al cargar notas:', error);
                });

            // Grupos (para maestros y alumnos)
            db.collection('groups')
                .where('members', 'array-contains', usuario.uid)
                .onSnapshot(snapshot => {
                    groups = [];
                    snapshot.forEach(doc => {
                        // Ensure we include all fields including code
                        const groupData = doc.data();
                        groups.push({ 
                            id: doc.id,
                            name: groupData.name, 
                            description: groupData.description,
                            code: groupData.code,
                            ownerId: groupData.ownerId,
                            members: groupData.members || []
                        });
                    });
                    renderizarGrupos();
                    guardarDatosLocales();
                }, error => {
                    console.error('Error al cargar grupos:', error);
                });
        }

        function cargarDatosLocales() {
            const materiasLocal = localStorage.getItem('materias');
            if (materiasLocal) {
                materias = JSON.parse(materiasLocal);
                renderizarMaterias();
            }

            const tareasLocal = localStorage.getItem('tareas');
            if (tareasLocal) {
                tareas = JSON.parse(tareasLocal);
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
            }

            const examenesLocal = localStorage.getItem('examenes');
            if (examenesLocal) {
                examenes = JSON.parse(examenesLocal);
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
            }

            const notesLocal = localStorage.getItem('notes');
            if (notesLocal) {
                notes = JSON.parse(notesLocal);
                renderizarNotas();
            }

            const groupsLocal = localStorage.getItem('groups');
            if (groupsLocal) {
                groups = JSON.parse(groupsLocal);
                renderizarGrupos();
            }

            verificarRecordatorios();
        }

        // No es necesario un `guardarDatos` general si se usa `onSnapshot` y se guardan individualmente.
        // `guardarDatosLocales` se llama en cada onSnapshot para mantener la cach√©.

        function guardarDatosLocales() {
            localStorage.setItem('materias', JSON.stringify(materias));
            localStorage.setItem('tareas', JSON.stringify(tareas));
            localStorage.setItem('examenes', JSON.stringify(examenes));
            localStorage.setItem('notes', JSON.stringify(notes));
            localStorage.setItem('groups', JSON.stringify(groups));
        }

        function configurarServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registrado con √©xito:', registration);
                }).catch(err => {
                    console.error('Error al registrar ServiceWorker:', err);
                });
            }
        }

        function verificarRecordatorios() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0); // Normalizar a inicio del d√≠a
            
            // Cargar notificaciones ya mostradas para evitar duplicados
            const storedNotifications = localStorage.getItem('notificacionesMostradas');
            notificacionesMostradas = storedNotifications ? JSON.parse(storedNotifications) : [];

            // Verificar tareas normales seg√∫n configuraci√≥n
            if (notificationSettings.normal.days > 0 || notificationSettings.normal.hours > 0) {
                const tareasNormales = tareas.filter(t => {
                    if (t.completada) return false; // No notificar tareas completadas
                    if (t.prioridad === 'alta') return false; // Las de alta prioridad se manejan aparte
                    
                    const fechaEntrega = new Date(t.fechaEntrega);
                    fechaEntrega.setHours(0, 0, 0, 0); // Normalizar a inicio del d√≠a

                    // Calcular la fecha de notificaci√≥n
                    const notifDate = new Date(fechaEntrega);
                    notifDate.setDate(notifDate.getDate() - notificationSettings.normal.days);
                    notifDate.setHours(notificationSettings.normal.hours, 0, 0, 0);

                    // Si la fecha de notificaci√≥n es hoy o ya pas√≥, y no se ha notificado antes
                    return notifDate.toDateString() === hoy.toDateString() && !notificacionesMostradas.includes(t.id);
                });
                
                tareasNormales.forEach(tarea => {
                    const materiaNombre = tarea.materia || (tarea.groupId ? groups.find(g => g.id === tarea.groupId)?.name : 'Grupo');
                    const mensaje = `Tarea pendiente para ${notificationSettings.normal.days} d√≠a(s) y ${notificationSettings.normal.hours} hora(s): ${tarea.descripcion} (${materiaNombre})`;
                    mostrarNotificacion(mensaje);
                    enviarNotificacionPush(mensaje);
                    notificacionesMostradas.push(tarea.id); // Marcar como notificada
                });
            }
            
            // Verificar tareas de alta prioridad seg√∫n configuraci√≥n
            if (notificationSettings.high.days > 0 || notificationSettings.high.hours > 0) {
                const tareasAltaPrioridad = tareas.filter(t => {
                    if (t.completada) return false;
                    if (t.prioridad !== 'alta') return false;
                    
                    const fechaEntrega = new Date(t.fechaEntrega);
                    fechaEntrega.setHours(0, 0, 0, 0);

                    const notifDate = new Date(fechaEntrega);
                    notifDate.setDate(notifDate.getDate() - notificationSettings.high.days);
                    notifDate.setHours(notificationSettings.high.hours, 0, 0, 0);

                    return notifDate.toDateString() === hoy.toDateString() && !notificacionesMostradas.includes(t.id);
                });
                
                tareasAltaPrioridad.forEach(tarea => {
                    const materiaNombre = tarea.materia || (tarea.groupId ? groups.find(g => g.id === tarea.groupId)?.name : 'Grupo');
                    const mensaje = `RECUERDA: Tarea de alta prioridad para ${notificationSettings.high.days} d√≠a(s) y ${notificationSettings.high.hours} hora(s): ${tarea.descripcion} (${materiaNombre})`;
                    mostrarNotificacion(mensaje);
                    enviarNotificacionPush(mensaje);
                    notificacionesMostradas.push(tarea.id);
                });
            }
            
            // Verificar ex√°menes seg√∫n configuraci√≥n
            if (notificationSettings.exam.days > 0 || notificationSettings.exam.hours > 0) {
                const examenesProximos = examenes.filter(e => {
                    if (e.completado) return false;
                    
                    const fechaExamen = new Date(e.fecha);
                    fechaExamen.setHours(0, 0, 0, 0);

                    const notifDate = new Date(fechaExamen);
                    notifDate.setDate(notifDate.getDate() - notificationSettings.exam.days);
                    notifDate.setHours(notificationSettings.exam.hours, 0, 0, 0);

                    return notifDate.toDateString() === hoy.toDateString() && !notificacionesMostradas.includes(e.id);
                });
                
                examenesProximos.forEach(examen => {
                    const materiaNombre = examen.materia || (examen.groupId ? groups.find(g => g.id === examen.groupId)?.name : 'Grupo');
                    const mensaje = `EXAMEN PR√ìXIMO en ${notificationSettings.exam.days} d√≠a(s) y ${notificationSettings.exam.hours} hora(s): ${examen.descripcion} (${materiaNombre}). √ötiles: ${examen.utiles || 'Ninguno especificado'}`;
                    mostrarNotificacion(mensaje);
                    enviarNotificacionPush(mensaje);
                    notificacionesMostradas.push(examen.id);
                });
            }
            
            // Guardar notificaciones mostradas
            localStorage.setItem('notificacionesMostradas', JSON.stringify(notificacionesMostradas));
        }

        function enviarNotificacionPush(mensaje) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Recordatorio', { body: mensaje });
            }
        }

        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('active');
            }
        }

        function abrirModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return;

            // Limpiar errores
            modal.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            modal.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('error');
            });
            
            modal.classList.add('active');
        }

        function cerrarModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('active');
        }

        function mostrarError(campoId, mensajeId) {
            const inputElement = document.getElementById(campoId);
            const errorMessageElement = document.getElementById(mensajeId);

            if (inputElement) {
                inputElement.classList.add('error');
                inputElement.style.animation = 'none'; // Reset animation
                void inputElement.offsetWidth; // Trigger reflow
                inputElement.style.animation = 'vibrate 0.5s';
            }
            if (errorMessageElement) {
                errorMessageElement.style.display = 'block';
            }
        }

        function ocultarError(campoId, mensajeId) {
            const inputElement = document.getElementById(campoId);
            const errorMessageElement = document.getElementById(mensajeId);

            if (inputElement) {
                inputElement.classList.remove('error');
                inputElement.style.animation = 'none'; // Stop animation
            }
            if (errorMessageElement) {
                errorMessageElement.style.display = 'none';
            }
        }

        function validarFormulario(modalId) {
            let valido = true;
            const modal = document.getElementById(modalId);
            if (!modal) return false;
            
            // Validar campos obligatorios
            modal.querySelectorAll('[required]').forEach(input => {
                if (!input.value.trim()) {
                    const errorId = `error-${input.id}`;
                    mostrarError(input.id, errorId);
                    valido = false;
                } else {
                    ocultarError(input.id, `error-${input.id}`);
                }
            });
            
            return valido;
        }

        async function guardarMateria() {
            if (!validarFormulario('modal-materia')) return;
            
            const nombreMateriaInput = document.getElementById('nombre-materia');
            const zonaMateriaInput = document.getElementById('zona-materia');

            const nombreMateria = nombreMateriaInput.value.trim();
            const zonaMateria = parseInt(zonaMateriaInput.value) || 0;

            const mode = document.getElementById('modal-materia').dataset.mode;

            if (mode === 'add') {
                if (materias.some(m => m.nombre === nombreMateria)) {
                    mostrarError('nombre-materia', 'error-nombre-materia');
                    document.getElementById('error-nombre-materia').textContent = 'Esta materia ya existe';
                    return;
                }

                const nuevaMateria = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('materias').doc().id : 'local-' + Date.now(),
                    nombre: nombreMateria,
                    zona: zonaMateria,
                    ownerId: usuario.uid // Materias are personal
                };
                
                materias.push(nuevaMateria);
                cerrarModal('modal-materia'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('materias').doc(nuevaMateria.id).set(nuevaMateria);
                    } catch (error) {
                        console.error("Error al guardar materia en Firebase:", error);
                        mostrarNotificacion("Error al guardar materia.");
                        // Revert local change if Firebase save fails
                        materias = materias.filter(m => m.id !== nuevaMateria.id);
                    }
                }
                mostrarNotificacion(`Materia "${nombreMateria}" agregada`);
            } else if (mode === 'edit') {
                const materiaId = document.getElementById('modal-materia').dataset.materiaId;
                const materiaToEdit = materias.find(m => m.id === materiaId);
                if (materiaToEdit) {
                    // Check for duplicate name if name is changed
                    if (materiaToEdit.nombre !== nombreMateria && materias.some(m => m.nombre === nombreMateria && m.id !== materiaId)) {
                        mostrarError('nombre-materia', 'error-nombre-materia');
                        document.getElementById('error-nombre-materia').textContent = 'Esta materia ya existe';
                        return;
                    }

                    const oldName = materiaToEdit.nombre;
                    materiaToEdit.nombre = nombreMateria;
                    materiaToEdit.zona = zonaMateria;
                    
                    cerrarModal('modal-materia'); // CERRAR MODAL INMEDIATAMENTE
                    if (usandoFirebase) {
                        try {
                            await db.collection('usuarios').doc(usuario.uid).collection('materias').doc(materiaToEdit.id).update(materiaToEdit);
                            // Update associated tasks/exams/notes if materia name changed
                            if (oldName !== nombreMateria) {
                                const batch = db.batch();
                                tareas.filter(t => t.materia === oldName).forEach(t => {
                                    batch.update(db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(t.id), { materia: nombreMateria });
                                });
                                examenes.filter(e => e.materia === oldName).forEach(e => {
                                    batch.update(db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(e.id), { materia: nombreMateria });
                                });
                                notes.filter(n => n.materia === oldName).forEach(n => {
                                    batch.update(db.collection('usuarios').doc(usuario.uid).collection('notes').doc(n.id), { materia: nombreMateria });
                                });
                                await batch.commit();
                            }
                        } catch (error) {
                            console.error("Error al actualizar materia en Firebase:", error);
                            mostrarNotificacion("Error al actualizar materia.");
                            // Revert local change if Firebase save fails
                            materiaToEdit.nombre = oldName; // Simple revert
                        }
                    }
                    mostrarNotificacion(`Materia "${nombreMateria}" actualizada`);
                }
            }
            
            guardarDatosLocales(); // Update local storage immediately
            renderizarMaterias();
            renderizarTareasPendientes(); // Re-render to update materia names if changed
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();
            
            // Limpiar formulario
            nombreMateriaInput.value = '';
            zonaMateriaInput.value = '';
        }

        function editarMateria(id) {
            const materiaToEdit = materias.find(m => m.id === id);
            if (!materiaToEdit) return;

            document.getElementById('modal-materia').dataset.mode = 'edit';
            document.getElementById('modal-materia').dataset.materiaId = id;
            document.getElementById('modal-materia').querySelector('.modal-title').textContent = 'Editar Materia';
            document.getElementById('nombre-materia').value = materiaToEdit.nombre;
            document.getElementById('zona-materia').value = materiaToEdit.zona;
            abrirModal('modal-materia');
        }

        function eliminarMateria(id) {
            showConfirm('¬øEliminar esta materia y todas sus tareas y ex√°menes asociados?', async () => {
                const materia = materias.find(m => m.id === id);
                if (!materia) return;
                
                const nombreMateria = materia.nombre;

                if (usandoFirebase) {
                    const batch = db.batch();
                    const userTasksRef = db.collection('usuarios').doc(usuario.uid).collection('tareas');
                    const userExamsRef = db.collection('usuarios').doc(usuario.uid).collection('examenes');
                    const userNotesRef = db.collection('usuarios').doc(usuario.uid).collection('notes');

                    // Delete associated tasks
                    const tasksToDelete = tareas.filter(t => t.materia === nombreMateria);
                    for (const t of tasksToDelete) {
                        batch.delete(userTasksRef.doc(t.id));
                    }

                    // Delete associated exams
                    const examsToDelete = examenes.filter(e => e.materia === nombreMateria);
                    for (const e of examsToDelete) {
                        batch.delete(userExamsRef.doc(e.id));
                    }

                    // Delete associated notes and their files
                    const notesToDelete = notes.filter(n => n.materia === nombreMateria);
                    for (const n of notesToDelete) {
                        batch.delete(userNotesRef.doc(n.id));
                        // if (n.attachments && n.attachments.length > 0) { // ELIMINADO
                        //     for (const attachment of n.attachments) { // ELIMINADO
                        //         try { // ELIMINADO
                        //             const fileRef = storage.refFromURL(attachment.url); // ELIMINADO
                        //             await fileRef.delete(); // ELIMINADO
                        //         } catch (error) { // ELIMINADO
                        //             console.warn(`Error al eliminar archivo ${attachment.name} del storage:`, error); // ELIMINADO
                        //         } // ELIMINADO
                        //     } // ELIMINADO
                        // } // ELIMINADO
                    }

                    // Delete the materia itself
                    batch.delete(db.collection('usuarios').doc(usuario.uid).collection('materias').doc(id));

                    try {
                        await batch.commit();
                        console.log("Materia y elementos asociados eliminados de Firebase.");
                    } catch (error) {
                        console.error("Error al eliminar materia y elementos asociados en Firebase:", error);
                        mostrarNotificacion("Error al eliminar materia y sus elementos asociados.");
                        return; // Stop if Firebase deletion fails
                    }
                }
                
                // Update local arrays
                tareas = tareas.filter(t => t.materia !== nombreMateria);
                examenes = examenes.filter(e => e.materia !== nombreMateria);
                notes = notes.filter(n => n.materia !== nombreMateria);
                materias = materias.filter(m => m.id !== id);
                
                if (materiaSeleccionada && materiaSeleccionada.id === id) {
                    materiaSeleccionada = null;
                    if (tituloTareas) tituloTareas.textContent = 'Tareas Pendientes';
                    if (fixedButtonsContainer) fixedButtonsContainer.style.display = 'none';
                    if (tareasPendientesContainer) tareasPendientesContainer.style.display = 'none';
                    if (examenesPendientesContainer) examenesPendientesContainer.style.display = 'none';
                    if (notesContainer) notesContainer.style.display = 'none';
                    if (tareasCompletadasContainer) tareasCompletadasContainer.style.display = 'none';
                    if (examenesCompletadosContainer) examenesCompletadosContainer.style.display = 'none';
                }
                
                guardarDatosLocales(); // Update local storage
                renderizarMaterias();
                renderizarTareasPendientes();
                renderizarExamenesPendientes();
                renderizarNotas();
                renderizarTareasCompletadas();
                renderizarExamenesCompletados();
                mostrarNotificacion('Materia eliminada');
            });
        }

        async function eliminarTarea(id) {
            showConfirm('¬øEliminar esta tarea permanentemente?', async () => {
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(id).delete();
                    } catch (error) {
                        console.error("Error al eliminar tarea de Firebase:", error);
                        mostrarNotificacion("Error al eliminar tarea.");
                        return;
                    }
                }
                tareas = tareas.filter(t => t.id !== id);
                guardarDatosLocales();
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias(); // Para actualizar el contador de puntos
                mostrarNotificacion('Tarea eliminada');
            });
        }

        async function eliminarExamen(id) {
            showConfirm('¬øEliminar este examen permanentemente?', async () => {
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(id).delete();
                    } catch (error) {
                        console.error("Error al eliminar examen de Firebase:", error);
                        mostrarNotificacion("Error al eliminar examen.");
                        return;
                    }
                }
                examenes = examenes.filter(e => e.id !== id);
                guardarDatosLocales();
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
                mostrarNotificacion('Examen eliminado');
            });
        }

        async function eliminarNota(id) {
            showConfirm('¬øEliminar esta nota permanentemente?', async () => {
                const noteToDelete = notes.find(n => n.id === id);
                // if (noteToDelete && noteToDelete.attachments && noteToDelete.attachments.length > 0) { // ELIMINADO
                //     // Delete files from storage // ELIMINADO
                //     for (const attachment of noteToDelete.attachments) { // ELIMINADO
                //         try { // ELIMINADO
                //             // Ensure the path is correct for deletion // ELIMINADO
                //             const fileRef = storage.refFromURL(attachment.url); // ELIMINADO
                //             await fileRef.delete(); // ELIMINADO
                //             console.log(`Archivo ${attachment.name} eliminado del storage.`); // ELIMINADO
                //         } catch (error) { // ELIMINADO
                //             console.warn(`Error al eliminar archivo ${attachment.name} del storage:`, error); // ELIMINADO
                //         } // ELIMINADO
                //     } // ELIMINADO
                // } // ELIMINADO

                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('notes').doc(id).delete();
                    } catch (error) {
                        console.error("Error al eliminar nota de Firebase:", error);
                        mostrarNotificacion("Error al eliminar nota.");
                        return;
                    }
                }
                notes = notes.filter(n => n.id !== id);
                guardarDatosLocales();
                renderizarNotas();
                mostrarNotificacion('Nota eliminada');
            });
        }

        function seleccionarMateria(materia) {
            materiaSeleccionada = materia;
            groupSeleccionado = null; // Deselect group
            
            // Actualizar UI
            document.querySelectorAll('.materia-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id == materia.id) {
                    item.classList.add('active');
                }
            });
            document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active')); // Deselect group UI

            // Mostrar contenido de la materia seleccionada
            if (tituloTareas) tituloTareas.textContent = `Tareas de ${materia.nombre}`;
            if (fixedButtonsContainer) fixedButtonsContainer.style.display = 'flex'; // Always show for personal materias
            
            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();

            // Hide group members section and group code display
            if (groupDetailsSection) groupDetailsSection.style.display = 'none';
            if (teacherGroupCodeDisplay) teacherGroupCodeDisplay.style.display = 'none';

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

       async function seleccionarGrupo(group) {
            materiaSeleccionada = null; // Deselect materia
            groupSeleccionado = group;
            
            // Actualizar UI
            renderizarMaterias(); // Deseleccionar visualmente cualquier materia activa
            document.querySelectorAll('.group-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id == group.id) {
                    item.classList.add('active');
                }
            });
            // Mostrar contenido del grupo seleccionado
            if (tituloTareas) tituloTareas.textContent = `Contenido del Grupo: ${group.name}`;
            
            // Mostrar botones de creaci√≥n solo si el usuario es el due√±o del grupo
            if (fixedButtonsContainer) {
                if (usuario && group.ownerId === usuario.uid) {
                    fixedButtonsContainer.style.display = 'flex';
                } else {
                    fixedButtonsContainer.style.display = 'none';
                }
            }

            // Render group-specific tasks, exams, notes (if any)
            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();

            // Show group members section and render members
            if (groupDetailsSection) groupDetailsSection.style.display = 'block'; 
            if (groupMembersList) await renderGroupMembers(group.id, groupMembersList); 
            
            // Show group code for teachers only
            if (userRole === 'teacher' && group.ownerId === (usuario ? usuario.uid : null)) { // Only owner teacher can see the code
                if (teacherGroupCodeDisplay) teacherGroupCodeDisplay.style.display = 'flex';
                // The element for displaying the code is inside the teacherGroupCodeDisplay div
                const generatedCodeDisplay = teacherGroupCodeDisplay.querySelector('#generated-group-code-display'); // Assuming you have this element
                if (generatedCodeDisplay) generatedCodeDisplay.textContent = group.code; 
            } else {
                if (teacherGroupCodeDisplay) teacherGroupCodeDisplay.style.display = 'none'; // Hide for students or non-owner teachers
            }
            if (window.innerWidth <= 768) {
                toggleSidebar(); // Ocultar la barra lateral en m√≥vil
            }
        }

        async function renderGroupMembers(groupId, listElement) {
            if (!listElement) return;
            listElement.innerHTML = ''; // Clear previous members
            try {
                const groupDoc = await db.collection('groups').doc(groupId).get();
                if (!groupDoc.exists) {
                    listElement.innerHTML = '<p>Grupo no encontrado.</p>';
                    return;
                }
                const members = groupDoc.data().members || [];
                if (members.length === 0) {
                    listElement.innerHTML = '<p>No hay miembros en este grupo.</p>';
                    return;
                }

                // Fetch all member details in parallel
                const memberPromises = members.map(memberId => db.collection('usuarios').doc(memberId).get());
                const memberDocs = await Promise.all(memberPromises);
                memberDocs.forEach(userDoc => {
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const memberItem = document.createElement('div');
                        memberItem.className = 'member-item';
                        memberItem.innerHTML = `
                            <div class="member-info">
                                <div class="member-name">${userData.fullName || userData.email}</div>
                                <div class="member-email">${userData.email} (${userData.role === 'teacher' ? 'Maestro' : 'Alumno'})</div>
                            </div>
                            ${usuario && groupDoc.data().ownerId === usuario.uid && userDoc.id !== usuario.uid ? `<div class="member-actions"><button class="member-btn remove" data-member-id="${userDoc.id}"><i class="fas fa-user-minus"></i></button></div>` : ''}
                        `;
                        listElement.appendChild(memberItem);
                        // Add event listener for remove button if applicable
                        if (usuario && groupDoc.data().ownerId === usuario.uid && userDoc.id !== usuario.uid) {
                            const removeButton = memberItem.querySelector('.member-btn.remove');
                            if (removeButton) {
                                removeButton.addEventListener('click', () => removeGroupMember(groupId, userDoc.id, userData.fullName || userData.email));
                            }
                        }
                    }
                });
            } catch (error) { 
                console.error("Error rendering group members:", error);
                listElement.innerHTML = '<p>Error al cargar miembros del grupo.</p>';
            }
        }

        async function removeGroupMember(groupId, memberId, memberName) {
            showConfirm(`¬øEst√°s seguro de que quieres eliminar a ${memberName} de este grupo?`, async () => {
                if (usandoFirebase) {
                    try {
                       await db.collection('groups').doc(groupId).update({
                            members: firebase.firestore.FieldValue.arrayRemove(memberId) // Changed userId to memberId
                        });
                        mostrarNotificacion(`${memberName} ha sido eliminado del grupo.`);
                        if (groupMembersList) renderGroupMembers(groupId, groupMembersList); // Re-render members list
                    } catch (error) {
                        console.error("Error removing group member:", error);
                        mostrarNotificacion("Error al eliminar miembro del grupo.");
                    }
                }
            });
        }

        function renderizarMaterias() {
            if (!materiasList) return;
            materiasList.innerHTML = '';
            
            if (materias.length === 0) {
                materiasList.innerHTML = '<p>No hay materias registradas</p>';
                return;
            }
            
            materias.forEach(materia => {
                const materiaElement = document.createElement('div');
                materiaElement.className = 'materia-item';
                if (materiaSeleccionada && materiaSeleccionada.id === materia.id) {
                    materiaElement.classList.add('active');
                }
                materiaElement.dataset.id = materia.id;
                
                const materiaContent = document.createElement('div');
                const totalPuntosEntregados = tareas
                    .filter(t => t.materia === materia.nombre && t.completada && t.entregada)
                    .reduce((sum, t) => sum + t.puntos, 0);

                materiaContent.innerHTML = `
                    <div>${materia.nombre}</div>
                    <div class="materia-info">
                        Entregados: ${totalPuntosEntregados}/${materia.zona}
                    </div>
                `;
                
                const materiaActions = document.createElement('div');
                materiaActions.className = 'materia-actions';
                materiaActions.innerHTML = `
                    <button class="materia-btn editar" onclick="app.editarMateria('${materia.id}')"><i class="fas fa-edit"></i></button>
                    <button class="materia-btn eliminar" onclick="app.eliminarMateria('${materia.id}')"><i class="fas fa-trash-alt"></i></button>
                `;
                
                materiaElement.appendChild(materiaContent);
                materiaElement.appendChild(materiaActions);
                
                materiaElement.addEventListener('click', (e) => {
                    // Evitar que el clic en los botones de acci√≥n active la selecci√≥n
                    if (!e.target.closest('.materia-actions')) {
                        seleccionarMateria(materia);
                    }
                });
                
                materiasList.appendChild(materiaElement);
            });
        }

        function renderizarGrupos() {
            if (!groupsList) return;
            groupsList.innerHTML = '';
            
            if (groups.length === 0) {
                groupsList.innerHTML = '<p>No hay grupos registrados</p>';
                return;
            }
            
            const uniqueGroups = [];
            const seenIds = new Set();
            
            for (const group of groups) {
                if (!seenIds.has(group.id)) {
                    seenIds.add(group.id);
                    uniqueGroups.push(group);
                }
            }
            
            uniqueGroups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'group-item';
                if (groupSeleccionado && groupSeleccionado.id === group.id) {
                    groupElement.classList.add('active');
                }
                groupElement.dataset.id = group.id;
                
                const groupContent = document.createElement('div');
                groupContent.innerHTML = `
                    <div>${group.name}</div>
                    <div class="group-info">${group.description || 'Sin descripci√≥n'}</div>
                `;
                
                const groupActions = document.createElement('div');
                groupActions.className = 'group-actions';
                if (userRole === 'teacher' && group.ownerId === (usuario ? usuario.uid : null)) {
                    groupActions.innerHTML = `
                        <button class="group-btn editar" onclick="app.editarGrupo('${group.id}')"><i class="fas fa-edit"></i></button>
                        <button class="group-btn eliminar" onclick="app.eliminarGrupo('${group.id}')"><i class="fas fa-trash-alt"></i></button>
                    `;
                } else {
                    groupActions.innerHTML = `
                        <button class="group-btn salir" onclick="app.leaveGroup('${group.id}')"><i class="fas fa-sign-out-alt"></i></button>
                    `;
                }
                
                groupElement.appendChild(groupContent);
                groupElement.appendChild(groupActions);
                
                groupElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.group-actions')) {
                        seleccionarGrupo(group);
                    }
                });
                
                groupsList.appendChild(groupElement);
            });
        }

        function renderizarTareasPendientes() {
            if (!listaTareasPendientes || !tareasPendientesContainer) return;
            listaTareasPendientes.innerHTML = '';
            
            let filteredTareas = [];
            if (materiaSeleccionada) {
                filteredTareas = tareas.filter(t => t.materia === materiaSeleccionada.nombre && !t.completada);
                tareasPendientesContainer.style.display = 'block';
            } else if (groupSeleccionado) {
                filteredTareas = tareas.filter(t => t.groupId === groupSeleccionado.id && !t.completada);
                tareasPendientesContainer.style.display = 'block';
            } else {
                tareasPendientesContainer.style.display = 'none';
                return;
            }
            
            if (filteredTareas.length === 0) {
                tareasPendientesContainer.style.display = 'none';
                return;
            }
            
            filteredTareas.forEach(tarea => {
                const tareaItem = document.createElement('div');
                tareaItem.className = 'tarea-item';
                
                // L√≥gica para permitir a maestros entregar tareas en sus propias materias y en grupos
                // y a estudiantes en sus propias materias
                const canComplete = (userRole === 'student' && materiaSeleccionada && !tarea.groupId) || // Alumno en materia personal
                                   (userRole === 'teacher' && (materiaSeleccionada && !tarea.groupId || groupSeleccionado && tarea.groupId)); // Maestro en materia personal o grupo

                tareaItem.innerHTML = `
                    <div class="tarea-info">
                        <div class="tarea-title">
                            <span class="tarea-prioridad ${tarea.prioridad === 'alta' ? 'prioridad-alta' : 'prioridad-normal'}"></span>
                            ${tarea.descripcion}
                            <span class="tarea-puntos">${tarea.puntos} pts</span>
                        </div>
                        <div class="tarea-descripcion">${tarea.materia || (tarea.groupId ? groups.find(g => g.id === tarea.groupId)?.name : '')}</div>
                        <div class="tarea-fecha">Entrega: ${tarea.fechaEntrega}</div>
                    </div>
                    <div class="tarea-actions">
                        ${canComplete ? `
                            <button class="tarea-btn completar" data-id="${tarea.id}" title="Marcar como entregada">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="tarea-btn editar" data-id="${tarea.id}" title="Editar tarea">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="tarea-btn eliminar" data-id="${tarea.id}" title="Eliminar tarea">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar eventos a los botones
                if (canComplete) {
                    const completarBtn = tareaItem.querySelector('.tarea-btn.completar');
                    if (completarBtn) {
                        completarBtn.addEventListener('click', () => completarTarea(tarea.id, true));
                    }
                }
                const editBtn = tareaItem.querySelector('.tarea-btn.editar');
                if (editBtn) editBtn.addEventListener('click', () => editarTarea(tarea.id));
                const deleteBtn = tareaItem.querySelector('.tarea-btn.eliminar');
                if (deleteBtn) deleteBtn.addEventListener('click', () => {
                    eliminarTarea(tarea.id);
                });
                
                listaTareasPendientes.appendChild(tareaItem);
            });
        }
        function renderizarExamenesPendientes() {
            if (!listaExamenesPendientes || !examenesPendientesContainer) return;
            listaExamenesPendientes.innerHTML = '';
            
            let filteredExams = [];
            if (materiaSeleccionada) {
                filteredExams = examenes.filter(e => e.materia === materiaSeleccionada.nombre && !e.completado);
                examenesPendientesContainer.style.display = 'block';
            } else if (groupSeleccionado) {
                filteredExams = examenes.filter(e => e.groupId === groupSeleccionado.id && !e.completado);
                examenesPendientesContainer.style.display = 'block';
            } else {
                examenesPendientesContainer.style.display = 'none';
                return;
            }
            
            if (filteredExams.length === 0) {
                examenesPendientesContainer.style.display = 'none';
                return;
            }
            
            filteredExams.forEach(examen => {
                const examenItem = document.createElement('div');
                examenItem.className = 'tarea-item';
                
                // L√≥gica para permitir a maestros entregar ex√°menes en sus propias materias y en grupos
                // y a estudiantes en sus propias materias
                const canComplete = (userRole === 'student' && materiaSeleccionada && !examen.groupId) || // Alumno en materia personal
                                   (userRole === 'teacher' && (materiaSeleccionada && !examen.groupId || groupSeleccionado && examen.groupId)); // Maestro en materia personal o grupo

                examenItem.innerHTML = `
                    <div class="tarea-info">
                        <div class="tarea-title">
                            <span class="tarea-prioridad prioridad-alta"></span>
                            ${examen.descripcion}
                            <span class="tarea-puntos">${examen.puntos} pts</span>
                        </div>
                        <div class="tarea-descripcion">${examen.materia || (examen.groupId ? groups.find(g => g.id === examen.groupId)?.name : '')}</div>
                        <div class="tarea-fecha">Fecha: ${examen.fecha}</div>
                        ${examen.utiles ? `<div class="tarea-descripcion">√ötiles: ${examen.utiles}</div>` : ''}
                    </div>
                    <div class="tarea-actions"> 
                        ${canComplete ? `<button class="tarea-btn completar" data-id="${examen.id}" title="Marcar como realizado"><i class="fas fa-check"></i></button>` : ''}
                        <button class="tarea-btn editar" data-id="${examen.id}" title="Editar examen">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="tarea-btn eliminar" data-id="${examen.id}" title="Eliminar examen">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar eventos a los botones
                if (canComplete) {
                    const completarBtn = examenItem.querySelector('.tarea-btn.completar');
                    if (completarBtn) {
                        completarBtn.addEventListener('click', () => completarExamen(examen.id, true));
                    }
                }
                const editBtn = examenItem.querySelector('.tarea-btn.editar');
                if (editBtn) editBtn.addEventListener('click', () => editarExamen(examen.id));
                const deleteBtn = examenItem.querySelector('.tarea-btn.eliminar');
                if (deleteBtn) deleteBtn.addEventListener('click', () => {
                    eliminarExamen(examen.id);
                });
                
                listaExamenesPendientes.appendChild(examenItem);
            });
        }

        function renderizarNotas() {
            if (!listaNotas || !notesContainer) return;
            listaNotas.innerHTML = '';

            let filteredNotes = [];
            // Si no hay materia o grupo seleccionado, mostrar todas las notas
            if (!materiaSeleccionada && !groupSeleccionado) {
                filteredNotes = notes;
            } else if (materiaSeleccionada) {
                filteredNotes = notes.filter(n => n.materia === materiaSeleccionada.nombre);
            } else if (groupSeleccionado) {
                filteredNotes = notes.filter(n => n.groupId === groupSeleccionado.id);
            }

            if (filteredNotes.length === 0) {
                notesContainer.style.display = 'none';
                return;
            } else {
                notesContainer.style.display = 'block'; // Asegurarse de que el contenedor sea visible
            }

            filteredNotes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';

                noteItem.innerHTML = `
                    <div class="note-info">
                        <div class="note-title">${note.title}</div>
                        <div class="note-content">${note.content || ''}</div>
                        <div class="note-date">Creada: ${new Date(note.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="note-actions">
                        <button class="note-btn editar" data-id="${note.id}" title="Editar nota"><i class="fas fa-edit"></i></button>
                        <button class="note-btn eliminar" data-id="${note.id}" title="Eliminar nota"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;

                const editBtn = noteItem.querySelector('.note-btn.editar');
                if (editBtn) editBtn.addEventListener('click', () => editarNota(note.id));
                const deleteBtn = noteItem.querySelector('.note-btn.eliminar');
                if (deleteBtn) deleteBtn.addEventListener('click', () => {
                    eliminarNota(note.id); // Direct call to eliminate
                });

                listaNotas.appendChild(noteItem);
            });
        }

        function renderizarTareasCompletadas() {
            if (!listaTareasCompletadas || !tareasCompletadasContainer) return;
            listaTareasCompletadas.innerHTML = '';
            
            let filteredTareas = [];
            if (materiaSeleccionada) {
                filteredTareas = tareas.filter(t => t.materia === materiaSeleccionada.nombre && t.completada);
                tareasCompletadasContainer.style.display = 'block';
            } else if (groupSeleccionado) {
                filteredTareas = tareas.filter(t => t.groupId === groupSeleccionado.id && t.completada);
                tareasCompletadasContainer.style.display = 'block';
            } else {
                tareasCompletadasContainer.style.display = 'none';
                return;
            }
            
            if (filteredTareas.length === 0) {
                tareasCompletadasContainer.style.display = 'none';
                return;
            }
            
            filteredTareas.forEach(tarea => {
                const tareaItem = document.createElement('div');
                tareaItem.className = `tarea-completada ${tarea.entregada ? 'entregada' : 'no-entregada'}`;
                
                tareaItem.innerHTML = `
                    <div class="tarea-completada-info">
                        <div>${tarea.descripcion}</div>
                        <div class="tarea-fecha">Entrega: ${tarea.fechaEntrega}</div>
                    </div>
                    <div>
                        <span class="tarea-completada-status ${tarea.entregada ? 'entregada-text' : 'no-entregada-text'}">
                            ${tarea.entregada ? 'Entregada' : 'No entregada'}
                        </span>
                        <span class="tarea-puntos">${tarea.puntos} pts</span>
                        <button class="tarea-btn eliminar" data-id="${tarea.id}" title="Eliminar tarea">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar evento al bot√≥n de eliminar
                const deleteBtn = tareaItem.querySelector('.tarea-btn.eliminar');
                if (deleteBtn) deleteBtn.addEventListener('click', () => {
                    eliminarTarea(tarea.id); // Direct call to eliminate
                });
                
                listaTareasCompletadas.appendChild(tareaItem);
            });
        }

        function renderizarExamenesCompletados() {
            if (!listaExamenesCompletados || !examenesCompletadosContainer) return;
            listaExamenesCompletados.innerHTML = '';
            
            let filteredExams = [];
            if (materiaSeleccionada) {
                filteredExams = examenes.filter(e => e.materia === materiaSeleccionada.nombre && e.completado);
                examenesCompletadosContainer.style.display = 'block';
            } else if (groupSeleccionado) {
                filteredExams = examenes.filter(e => e.groupId === groupSeleccionado.id && e.completado);
                examenesCompletadosContainer.style.display = 'block';
            } else {
                examenesCompletadosContainer.style.display = 'none';
                return;
            }
            
            if (filteredExams.length === 0) {
                examenesCompletadosContainer.style.display = 'none';
                return;
            }
            
            filteredExams.forEach(examen => {
                const examenItem = document.createElement('div');
                examenItem.className = `tarea-completada ${examen.realizado ? 'entregada' : 'no-entregada'}`;
                
                examenItem.innerHTML = `
                    <div class="tarea-completada-info">
                        <div>${examen.descripcion}</div>
                        <div class="tarea-fecha">Fecha: ${examen.fecha}</div>
                    </div>
                    <div>
                        <span class="tarea-completada-status ${examen.realizado ? 'entregada-text' : 'no-entregada-text'}">
                            ${examen.realizado ? 'Realizado' : 'No realizado'}
                        </span>
                        <span class="tarea-puntos">${examen.puntos} pts</span>
                        <button class="tarea-btn eliminar" data-id="${examen.id}" title="Eliminar examen">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar evento al bot√≥n de eliminar
                const deleteBtn = examenItem.querySelector('.tarea-btn.eliminar');
                if (deleteBtn) deleteBtn.addEventListener('click', () => {
                    eliminarExamen(examen.id); // Direct call to eliminate
                });
                
                listaExamenesCompletados.appendChild(examenItem);
            });
        }

        function editarTarea(id) {
            tareaEditando = tareas.find(t => t.id === id);
            if (!tareaEditando) return;
            
            if (document.getElementById('modal-tarea-title')) document.getElementById('modal-tarea-title').textContent = 'Editar Tarea';
            if (document.getElementById('tarea-descripcion')) document.getElementById('tarea-descripcion').value = tareaEditando.descripcion;
            if (document.getElementById('tarea-puntos')) document.getElementById('tarea-puntos').value = tareaEditando.puntos;
            if (document.getElementById('tarea-fecha')) document.getElementById('tarea-fecha').value = tareaEditando.fechaEntrega;
            if (document.getElementById('tarea-prioridad')) document.getElementById('tarea-prioridad').checked = tareaEditando.prioridad === 'alta';
            
            if (document.getElementById('tarea-status-group')) document.getElementById('tarea-status-group').style.display = 'block';
            const statusRadio = document.querySelector(`input[name="tarea-status"][value="${tareaEditando.entregada ? 'entregada' : 'no-entregada'}"]`);
            if (statusRadio) statusRadio.checked = true;
            
            if (document.getElementById('cancelar-tarea')) document.getElementById('cancelar-tarea').style.display = 'block';
            abrirModal('modal-tarea');
        }

        async function guardarTarea() {
            if (!validarFormulario('modal-tarea')) return;
            
            const descripcion = document.getElementById('tarea-descripcion').value.trim();
            const puntos = parseInt(document.getElementById('tarea-puntos').value) || 0;
            const fechaEntrega = document.getElementById('tarea-fecha').value;
            const prioridad = document.getElementById('tarea-prioridad').checked ? 'alta' : 'normal';
            const entregada = tareaEditando ? 
                (document.querySelector('input[name="tarea-status"]:checked') ? document.querySelector('input[name="tarea-status"]:checked').value === 'entregada' : true) : true;
                
            // Validar puntos m√°ximos si es una materia
            if (materiaSeleccionada) {
                const materia = materias.find(m => m.id === materiaSeleccionada.id);
                if (materia && puntos > materia.zona) {
                    mostrarNotificacion(`Los puntos no pueden ser mayores que la zona de la materia (${materia.zona})`);
                    return;
                }
            }

            if (tareaEditando) {
                // Editar tarea existente
                tareaEditando.descripcion = descripcion;
                tareaEditando.puntos = puntos;
                tareaEditando.fechaEntrega = fechaEntrega;
                tareaEditando.prioridad = prioridad;
                tareaEditando.entregada = entregada;
                
                cerrarModal('modal-tarea'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tareaEditando.id).update(tareaEditando);
                    } catch (error) {
                        console.error("Error al actualizar tarea en Firebase:", error);
                        mostrarNotificacion("Error al actualizar tarea.");
                    }
                }
                mostrarNotificacion('Tarea actualizada');
            } else {
                // Nueva tarea
                const nuevaTarea = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('tareas').doc().id : 'local-' + Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null,
                    groupId: groupSeleccionado ? groupSeleccionado.id : null,
                    descripcion,
                    puntos,
                    fechaEntrega,
                    prioridad,
                    completada: false,
                    entregada: true,
                    tipo: 'tarea',
                    createdAt: Date.now()
                };
                tareas.push(nuevaTarea);
                
                cerrarModal('modal-tarea'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(nuevaTarea.id).set(nuevaTarea);
                    } catch (error) {
                        console.error("Error al guardar tarea en Firebase:", error);
                        mostrarNotificacion("Error al guardar tarea.");
                        tareas = tareas.filter(t => t.id !== nuevaTarea.id); // Revert local change
                    }
                }
                mostrarNotificacion('Tarea agregada');
                
                // Programar recordatorios
                programarRecordatoriosTarea(nuevaTarea);
            }
            
            guardarDatosLocales();
            renderizarTareasPendientes();
            renderizarTareasCompletadas();
            renderizarMaterias(); // Para actualizar el contador de puntos
        }

        function programarRecordatoriosTarea(tarea) {
            const fechaEntrega = new Date(tarea.fechaEntrega);
            const hoy = new Date();
            
            // Diferencia en milisegundos
            const diffTime = fechaEntrega.getTime() - hoy.getTime();
            
            // Convertir a d√≠as y horas
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = diffHours % 24;
            
            // Programar notificaciones seg√∫n prioridad
            if (tarea.prioridad === 'alta' && 
                (notificationSettings.high.days > 0 || notificationSettings.high.hours > 0)) {
                
                const targetDays = notificationSettings.high.days;
                const targetHours = notificationSettings.high.hours;
                
                // Calcular la fecha de notificaci√≥n deseada
                const notifDate = new Date(fechaEntrega);
                notifDate.setDate(notifDate.getDate() - targetDays);
                notifDate.setHours(notifDate.getHours() - targetHours);
                
                // Si la fecha de notificaci√≥n deseada es en el futuro o hoy
                if (notifDate.getTime() >= hoy.getTime() && !notificacionesMostradas.includes(tarea.id)) {
                    // En una implementaci√≥n real usar√≠as el API de notificaciones push
                    console.log(`Recordatorio programado para ${notifDate.toLocaleString()}: Tarea de alta prioridad "${tarea.descripcion}"`);
                    // Aqu√≠ se podr√≠a usar setTimeout para simular la notificaci√≥n o una API de notificaciones push
                }
            } else if (notificationSettings.normal.days > 0 || notificationSettings.normal.hours > 0) {
                const targetDays = notificationSettings.normal.days;
                const targetHours = notificationSettings.normal.hours;
                
                const notifDate = new Date(fechaEntrega);
                notifDate.setDate(notifDate.getDate() - targetDays);
                notifDate.setHours(notifDate.getHours() - targetHours);
                
                if (notifDate.getTime() >= hoy.getTime() && !notificacionesMostradas.includes(tarea.id)) {
                    console.log(`Recordatorio programado para ${notifDate.toLocaleString()}: Tarea "${tarea.descripcion}"`);
                }
            }
        }

        async function cancelarTarea() {
            showConfirm('¬øCancelar esta tarea?', async () => {
                if (!tareaEditando) return;
                tareaEditando.completada = true;
                tareaEditando.entregada = false;
                
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tareaEditando.id).update(tareaEditando);
                    } catch (error) {
                        console.error("Error al cancelar tarea en Firebase:", error);
                        mostrarNotificacion("Error al cancelar tarea.");
                        return;
                    }
                }
                guardarDatosLocales();
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias(); // Para actualizar el contador de puntos
                cerrarModal('modal-tarea');
                
                mostrarNotificacion('Tarea cancelada');
            });
        }

        async function completarTarea(id, entregada) {
            const tarea = tareas.find(t => t.id === id);
            if (!tarea) return;
            
            tarea.completada = true;
            tarea.entregada = entregada;
            
            if (usandoFirebase) {
                try {
                    await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tarea.id).update(tarea);
                } catch (error) {
                    console.error("Error al completar tarea en Firebase:", error);
                    mostrarNotificacion("Error al completar tarea.");
                    return;
                }
            }

            if (entregada) {
                mostrarNotificacion(`Tarea entregada: +${tarea.puntos} puntos`);
            } else {
                mostrarNotificacion('Tarea marcada como no entregada');
            }
            
            guardarDatosLocales();
            
            // Animaci√≥n de desaparici√≥n
            const tareaElement = document.querySelector(`.tarea-item button.completar[data-id="${id}"]`)?.closest('.tarea-item');
            if (tareaElement) {
                tareaElement.classList.add('fade-out');
                
                setTimeout(() => {
                    renderizarTareasPendientes();
                    renderizarTareasCompletadas();
                    renderizarMaterias(); // Para actualizar el contador de puntos
                }, 300);
            } else {
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias(); // Para actualizar el contador de puntos
            }
        }

        function editarExamen(id) {
            examenEditando = examenes.find(e => e.id === id);
            if (!examenEditando) return;
            
            if (document.getElementById('modal-examen-title')) document.getElementById('modal-examen-title').textContent = 'Editar Examen';
            if (document.getElementById('examen-descripcion')) document.getElementById('examen-descripcion').value = examenEditando.descripcion;
            if (document.getElementById('examen-puntos')) document.getElementById('examen-puntos').value = examenEditando.puntos;
            if (document.getElementById('examen-fecha')) document.getElementById('examen-fecha').value = examenEditando.fecha;
            if (document.getElementById('examen-utiles')) document.getElementById('examen-utiles').value = examenEditando.utiles || '';
            
            if (document.getElementById('examen-status-group')) document.getElementById('examen-status-group').style.display = 'block';
            const statusRadio = document.querySelector(`input[name="examen-status"][value="${examenEditando.realizado ? 'realizado' : 'no-realizado'}"]`);
            if (statusRadio) statusRadio.checked = true;
            
            abrirModal('modal-examen');
        }

        async function guardarExamen() {
            if (!validarFormulario('modal-examen')) return;
            
            const descripcion = document.getElementById('examen-descripcion').value.trim();
            const puntos = parseInt(document.getElementById('examen-puntos').value) || 0;
            const fecha = document.getElementById('examen-fecha').value;
            const utiles = document.getElementById('examen-utiles').value.trim();
            const realizado = examenEditando ? 
                (document.querySelector('input[name="examen-status"]:checked') ? document.querySelector('input[name="examen-status"]:checked').value === 'realizado' : false) : false;

            if (examenEditando) {
                // Editar examen existente
                examenEditando.descripcion = descripcion;
                examenEditando.puntos = puntos;
                examenEditando.fecha = fecha;
                examenEditando.utiles = utiles;
                examenEditando.realizado = realizado;
                
                cerrarModal('modal-examen'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(examenEditando.id).update(examenEditando);
                    } catch (error) {
                        console.error("Error al actualizar examen en Firebase:", error);
                        mostrarNotificacion("Error al actualizar examen.");
                    }
                }
                mostrarNotificacion('Examen actualizado');
            } else {
                // Nuevo examen
                const nuevoExamen = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('examenes').doc().id : 'local-' + Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null,
                    groupId: groupSeleccionado ? groupSeleccionado.id : null,
                    descripcion,
                    puntos,
                    fecha,
                    utiles,
                    completado: false,
                    realizado: false,
                    tipo: 'examen',
                    createdAt: Date.now()
                };
                examenes.push(nuevoExamen);
                
                cerrarModal('modal-examen'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(nuevoExamen.id).set(nuevoExamen);
                    } catch (error) {
                        console.error("Error al guardar examen en Firebase:", error);
                        mostrarNotificacion("Error al guardar examen.");
                        examenes = examenes.filter(e => e.id !== nuevoExamen.id); // Revert local change
                    }
                }
                mostrarNotificacion('Examen agregado');
                
                // Programar recordatorios
                programarRecordatoriosExamen(nuevoExamen);
            }
            
            guardarDatosLocales();
            renderizarExamenesPendientes();
            renderizarExamenesCompletados();
        }

        function programarRecordatoriosExamen(examen) {
            if (notificationSettings.exam.days <= 0 && notificationSettings.exam.hours <= 0) return;
            
            const fechaExamen = new Date(examen.fecha);
            const hoy = new Date();
            
            // Diferencia en milisegundos
            const diffTime = fechaExamen.getTime() - hoy.getTime();
            
            // Convertir a d√≠as y horas
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = diffHours % 24;
            
            const targetDays = notificationSettings.exam.days;
            const targetHours = notificationSettings.exam.hours;
            
            // Calcular la fecha de notificaci√≥n deseada
            const notifDate = new Date(fechaExamen);
            notifDate.setDate(notifDate.getDate() - targetDays);
            notifDate.setHours(notifDate.getHours() - targetHours);
            
            // Si la fecha de notificaci√≥n deseada es en el futuro o hoy
            if (notifDate.getTime() >= hoy.getTime() && !notificacionesMostradas.includes(examen.id)) {
                // En una implementaci√≥n real usar√≠as el API de notificaciones push
                console.log(`Recordatorio programado para ${notifDate.toLocaleString()}: Examen "${examen.descripcion}" - √ötiles: ${examen.utiles || 'Ninguno'}`);
                // Aqu√≠ se podr√≠a usar setTimeout para simular la notificaci√≥n o una API de notificaciones push
            }
        }

        async function completarExamen(id, realizado) {
            const examen = examenes.find(e => e.id === id);
            if (!examen) return;
            
            examen.completado = true;
            examen.realizado = realizado;
            
            if (usandoFirebase) {
                try {
                    await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(examen.id).update(examen);
                } catch (error) {
                    console.error("Error al completar examen en Firebase:", error);
                    mostrarNotificacion("Error al completar examen.");
                    return;
                }
            }

            if (realizado) {
                mostrarNotificacion(`Examen realizado: +${examen.puntos} puntos`);
            } else {
                mostrarNotificacion('Examen marcado como no realizado');
            }
            
            guardarDatosLocales();
            
            // Animaci√≥n de desaparici√≥n
            const examenElement = document.querySelector(`.tarea-item button.completar[data-id="${id}"]`)?.closest('.tarea-item');
            if (examenElement) {
                examenElement.classList.add('fade-out');
                
                setTimeout(() => {
                    renderizarExamenesPendientes();
                    renderizarExamenesCompletados();
                }, 300);
            } else {
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
            }
        }

        function editarNota(id) {
            noteEditando = notes.find(n => n.id === id);
            if (!noteEditando) return;

            if (document.getElementById('modal-nota-title')) document.getElementById('modal-nota-title').textContent = 'Editar Nota';
            if (document.getElementById('nota-titulo')) document.getElementById('nota-titulo').value = noteEditando.title;
            if (document.getElementById('nota-contenido')) document.getElementById('nota-contenido').value = noteEditando.content || '';
            // currentFiles = noteEditando.attachments || []; // ELIMINADO
            // renderNoteFiles(); // ELIMINADO
            // if (uploadProgressContainer) uploadProgressContainer.style.display = 'none'; // Hide progress bar // ELIMINADO
            // if (uploadProgressBar) { // ELIMINADO
            //     uploadProgressBar.style.width = '0%'; // ELIMINADO
            //     uploadProgressBar.textContent = '0%'; // ELIMINADO
            // } // ELIMINADO
            abrirModal('modal-nota');
        }

        async function guardarNota() {
            if (!validarFormulario('modal-nota')) return;

            const title = document.getElementById('nota-titulo').value.trim();
            const content = document.getElementById('nota-contenido').value.trim();
            
            // Filter out files that are already uploaded (have a URL) // ELIMINADO
            // const filesToUpload = currentFiles.filter(file => file instanceof File); // ELIMINADO
            // const existingFiles = currentFiles.filter(file => !(file instanceof File)); // ELIMINADO

            // const uploadedFiles = [...existingFiles]; // Start with existing files // ELIMINADO

            // if (filesToUpload.length > 0 && usandoFirebase) { // ELIMINADO
            //     if (uploadProgressContainer) uploadProgressContainer.style.display = 'block'; // ELIMINADO
            //     if (uploadProgressBar) { // ELIMINADO
            //         uploadProgressBar.style.width = '0%'; // ELIMINADO
            //         uploadProgressBar.textContent = '0%'; // ELIMINADO
            //     } // ELIMINADO
            // } // ELIMINADO

            // for (let i = 0; i < filesToUpload.length; i++) { // ELIMINADO
            //     const file = filesToUpload[i]; // ELIMINADO
            //     const storagePath = `notes/${usuario.uid}/${Date.now()}-${file.name}`; // ELIMINADO
            //     const storageRef = storage.ref(storagePath); // ELIMINADO
            //     const uploadTask = storageRef.put(file); // ELIMINADO

            //     try { // ELIMINADO
            //         await new Promise((resolve, reject) => { // ELIMINADO
            //             uploadTask.on('state_changed', // ELIMINADO
            //                 (snapshot) => { // ELIMINADO
            //                     const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; // ELIMINADO
            //                     if (uploadProgressBar) { // ELIMINADO
            //                         uploadProgressBar.style.width = progress + '%'; // ELIMINADO
            //                         uploadProgressBar.textContent = Math.round(progress) + '%'; // ELIMINADO
            //                     }, // ELIMINADO
            //                 (error) => { // ELIMINADO
            //                     console.error("Error uploading file:", file.name, error); // ELIMINADO
            //                     reject(error); // ELIMINADO
            //                 }, // ELIMINADO
            //                 async () => { // ELIMINADO
            //                     const downloadURL = await uploadTask.snapshot.ref.getDownloadURL(); // ELIMINADO
            //                     uploadedFiles.push({ name: file.name, url: downloadURL, size: file.size, type: file.type }); // ELIMINADO
            //                     resolve(); // ELIMINADO
            //                 } // ELIMINADO
            //             ); // ELIMINADO
            //         }); // ELIMINADO
            //     } catch (error) { // ELIMINADO
            //         if (uploadProgressContainer) uploadProgressContainer.style.display = 'none'; // ELIMINADO
            //         mostrarNotificacion(`Error al subir archivo ${file.name}.`); // ELIMINADO
            //         return; // Stop saving if upload fails // ELIMINADO
            //     } // ELIMINADO
            // } // ELIMINADO
            // if (uploadProgressContainer) uploadProgressContainer.style.display = 'none'; // Hide progress bar after all uploads // ELIMINADO

            if (noteEditando) {
                // Update existing note
                noteEditando.title = title;
                noteEditando.content = content;
                noteEditando.attachments = []; // No attachments anymore

                cerrarModal('modal-nota'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('notes').doc(noteEditando.id).update(noteEditando);
                    } catch (error) {
                        console.error("Error al actualizar nota en Firebase:", error);
                        mostrarNotificacion("Error al actualizar nota.");
                    }
                }
                mostrarNotificacion('Nota actualizada');
            } else {
                // Nueva nota
                const newNote = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('notes').doc().id : 'local-' + Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null,
                    groupId: groupSeleccionado ? groupSeleccionado.id : null,
                    title,
                    content,
                    attachments: [], // No attachments anymore
                    createdAt: Date.now(),
                    ownerId: usuario.uid // Para rastrear qui√©n cre√≥ la nota
                };
                notes.push(newNote);

                cerrarModal('modal-nota'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('usuarios').doc(usuario.uid).collection('notes').doc(newNote.id).set(newNote);
                    } catch (error) {
                        console.error("Error al guardar nota en Firebase:", error);
                        mostrarNotificacion("Error al guardar nota.");
                        notes = notes.filter(n => n.id !== newNote.id); // Revert local change
                    }
                }
                mostrarNotificacion('Nota agregada');
            }

            guardarDatosLocales();
            renderizarNotas();
        }
        

        // async function handleNoteFileSelect(event) { // ELIMINADO
        //     const files = Array.from(event.target.files); // ELIMINADO
        //     if (files.length === 0) return; // ELIMINADO
            
        //     if (uploadProgressContainer) uploadProgressContainer.style.display = 'block'; // ELIMINADO
        //     if (uploadProgressBar) { // ELIMINADO
        //         uploadProgressBar.style.width = '0%'; // ELIMINADO
        //         uploadProgressBar.textContent = '0%'; // ELIMINADO
        //     } // ELIMINADO

        //     for (const file of files) { // ELIMINADO
        //         if (!usandoFirebase) { // ELIMINADO
        //             mostrarNotificacion("No se pueden subir archivos en modo local."); // ELIMINADO
        //             continue; // ELIMINADO
        //         } // ELIMINADO
        //         try { // ELIMINADO
        //             const storagePath = `notes/${usuario.uid}/${Date.now()}_${file.name}`; // ELIMINADO
        //             const storageRef = storage.ref(storagePath); // ELIMINADO
        //             const uploadTask = storageRef.put(file); // ELIMINADO

        //             await new Promise((resolve, reject) => { // ELIMINADO
        //                 uploadTask.on('state_changed', // ELIMINADO
        //                     (snapshot) => { // ELIMINADO
        //                         const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; // ELIMINADO
        //                         if (uploadProgressBar) { // ELIMINADO
        //                             uploadProgressBar.style.width = progress + '%'; // ELIMINADO
        //                             uploadProgressBar.textContent = Math.round(progress) + '%'; // ELIMINADO
        //                         } // ELIMINADO
        //                     }, // ELIMINADO
        //                     (error) => { // ELIMINADO
        //                         console.error("Error uploading file:", error); // ELIMINADO
        //                         reject(error); // ELIMINADO
        //                     }, // ELIMINADO
        //                     async () => { // ELIMINADO
        //                         const downloadURL = await uploadTask.snapshot.ref.getDownloadURL(); // ELIMINADO
        //                         currentFiles.push({ // ELIMINADO
        //                             name: file.name, // ELIMINADO
        //                             url: downloadURL, // ELIMINADO
        //                             size: file.size, // ELIMINADO
        //                             type: file.type // ELIMINADO
        //                         }); // ELIMINADO
        //                         resolve(); // ELIMINADO
        //                     } // ELIMINADO
        //                 ); // ELIMINADO
        //             }); // ELIMINADO
        //         } catch (error) { // ELIMINADO
        //             console.error("Error uploading file:", error); // ELIMINADO
        //             mostrarNotificacion(`Error al subir archivo ${file.name}.`); // ELIMINADO
        //         } // ELIMINADO
        //     } // ELIMINADO

        //     if (uploadProgressContainer) uploadProgressContainer.style.display = 'none'; // ELIMINADO
        //     renderNoteFiles(); // ELIMINADO
        //     if (event.target) event.target.value = ''; // Clear input to allow re-selection of same file // ELIMINADO
        // } // ELIMINADO

        // function handleNoteFileDrop(event) { // ELIMINADO
        //     event.preventDefault(); // ELIMINADO
        //     event.stopPropagation(); // ELIMINADO
        //     if (notaFileUploadContainer) notaFileUploadContainer.classList.remove('dragover'); // ELIMINADO
        //     const files = Array.from(event.dataTransfer.files); // ELIMINADO
        //     addFilesToCurrent(files); // ELIMINADO
        // } // ELIMINADO

        // function addFilesToCurrent(files) { // ELIMINADO
        //     files.forEach(file => { // ELIMINADO
        //         // Prevent adding duplicate files by name // ELIMINADO
        //         if (!currentFiles.some(f => f.name === file.name)) { // ELIMINADO
        //             currentFiles.push(file); // ELIMINADO
        //         } // ELIMINADO
        //     }); // ELIMINADO
        //     renderNoteFiles(); // ELIMINADO
        // } // ELIMINADO

        // function removeNoteFile(index) { // ELIMINADO
        //     currentFiles.splice(index, 1); // ELIMINADO
        //     renderNoteFiles(); // ELIMINADO
        // } // ELIMINADO

        // function renderNoteFiles() { // ELIMINADO
        //     if (!notaFileList) return; // ELIMINADO
        //     notaFileList.innerHTML = ''; // ELIMINADO
        //     if (currentFiles.length === 0) { // ELIMINADO
        //         notaFileList.style.display = 'none'; // ELIMINADO
        //         return; // ELIMINADO
        //     } // ELIMINADO
        //     notaFileList.style.display = 'block'; // ELIMINADO
        //     currentFiles.forEach((file, index) => { // ELIMINADO
        //         const listItem = document.createElement('div'); // ELIMINADO
        //         listItem.className = 'file-list-item'; // ELIMINADO
        //         const fileName = file.name || (file.url ? file.url.split('/').pop().split('?')[0] : 'Archivo desconocido'); // ELIMINADO
        //         listItem.innerHTML = ` // ELIMINADO
        //             <span>${fileName}</span> // ELIMINADO
        //             <button type="button" data-index="${index}"><i class="fas fa-times"></i></button> // ELIMINADO
        //         `; // ELIMINADO
        //         const removeButton = listItem.querySelector('button'); // ELIMINADO
        //         if (removeButton) removeButton.addEventListener('click', () => removeNoteFile(index)); // ELIMINADO
        //         notaFileList.appendChild(listItem); // ELIMINADO
        //     }); // ELIMINADO
        // } // ELIMINADO

        function generateUniqueCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; // Removed special chars for easier sharing
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function guardarGrupo() {
            if (!validarFormulario('modal-group')) return;

            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const mode = document.getElementById('modal-group').dataset.mode;


            if (mode === 'add') {
                const newGroupCode = generateUniqueCode(); // Generate unique code
                const groupId = usandoFirebase ? db.collection('groups').doc().id : 'local-' + Date.now(); 

                const newGroup = {
                    id: groupId,
                    name: groupName,
                    description: groupDescription,
                    code: newGroupCode, // Store the unique code
                    ownerId: usuario ? usuario.uid : null,
                    ownerName: userFullName,
                    members: [usuario ? usuario.uid : null].filter(Boolean), // Ensure member is not null
                    createdAt: Date.now(),
                };

                cerrarModal('modal-group'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('groups').doc(newGroup.id).set(newGroup);
                        groups.push(newGroup);
                        mostrarNotificacion(`Grupo "${groupName}" creado.`);
                        // Display the generated code
                        if (generatedGroupCode) generatedGroupCode.textContent = newGroup.code;
                        if (groupCodeDisplayModal) groupCodeDisplayModal.style.display = 'flex';
                        if (groupCodeInfoMessage) groupCodeInfoMessage.style.display = 'block';
                        renderizarGrupos();
                    } catch (error) {
                        console.error("Error al guardar grupo en Firebase:", error);
                        mostrarNotificacion("Error al crear grupo.");
                        groups = groups.filter(g => g.id !== newGroup.id); // Revert local change
                    }
                } else {
                    groups.push(newGroup);
                    mostrarNotificacion(`Grupo "${groupName}" creado.`);
                    if (generatedGroupCode) generatedGroupCode.textContent = newGroup.code;
                    if (groupCodeDisplayModal) groupCodeDisplayModal.style.display = 'flex';
                    if (groupCodeInfoMessage) groupCodeInfoMessage.style.display = 'block';
                    renderizarGrupos();
                }
            } else if (mode === 'edit') {
                const groupId = groupEditando.id;
                const groupToUpdate = groups.find(g => g.id === groupId);
                if (groupToUpdate) {
                    groupToUpdate.name = groupName;
                    groupToUpdate.description = groupDescription;
                    cerrarModal('modal-group'); // CERRAR MODAL INMEDIATAMENTE
                    if (usandoFirebase) {
                        try {
                            await db.collection('groups').doc(groupId).update({
                                name: groupName,
                                description: groupDescription
                            });
                        } catch (error) {
                            console.error("Error al actualizar grupo en Firebase:", error);
                            mostrarNotificacion("Error al actualizar grupo.");
                        }
                    }
                    mostrarNotificacion(`Grupo "${groupName}" actualizado.`);
                }
            }
            
            guardarDatosLocales(); // Update local storage
        }

        function editarGrupo(id) {
            groupEditando = groups.find(g => g.id === id);
            if (!groupEditando) return;

            document.getElementById('modal-group').dataset.mode = 'edit';
            document.getElementById('modal-group-title').textContent = 'Editar Grupo';
            document.getElementById('group-name').value = groupEditando.name;
            document.getElementById('group-description').value = groupEditando.description || '';
            if (groupCodeDisplayModal) groupCodeDisplayModal.style.display = 'none'; // Hide code display for editing
            if (groupCodeInfoMessage) groupCodeInfoMessage.style.display = 'none'; // Hide info message for editing
            abrirModal('modal-group');
        }

        function copyGroupCode() {
            if (!generatedGroupCode) return;
            const code = generatedGroupCode.textContent;
            navigator.clipboard.writeText(code).then(() => {
                mostrarNotificacion('C√≥digo de grupo copiado al portapapeles.');
            }).catch(err => {
                console.error('Error al copiar el c√≥digo:', err);
                mostrarNotificacion('Error al copiar el c√≥digo.');
            });
        }

        async function copyCurrentGroupCode() {
            if (!groupSeleccionado || !groupSeleccionado.code) {
                mostrarNotificacion('No hay un grupo seleccionado o el c√≥digo no est√° disponible.');
                return;
            }
            const code = groupSeleccionado.code; // Get code from selected group
            try {
                await navigator.clipboard.writeText(code);
                if (copyCodeMessage) {
                    copyCodeMessage.style.display = 'block';
                    setTimeout(() => {
                        copyCodeMessage.style.display = 'none';
                    }, 5000);
                }
                mostrarNotificacion('C√≥digo de invitaci√≥n copiado.');
            } catch (err) {
                console.error('Error al copiar el c√≥digo:', err);
                mostrarNotificacion('Error al copiar el c√≥digo.');
            }
        }

     async function joinGroup(joinInput) {
        if (!joinInput) {
            mostrarNotificacion('Por favor, introduce un c√≥digo de grupo.');
            return;
        }
        if (!usuario || !usuario.uid) {
            mostrarNotificacion('Debes iniciar sesi√≥n para unirte a un grupo.');
            localStorage.setItem('pendingGroupJoinCode', joinInput); // Store the code
            mostrarLoginScreen(); // Redirect to login
            return;
        }
        try {
            // Query groups by the unique code
            const groupsRef = db.collection('groups');
            const querySnapshot = await groupsRef.where('code', '==', joinInput).limit(1).get();
            if (querySnapshot.empty) {
                mostrarNotificacion('Grupo no encontrado. Verifica el c√≥digo.');
                return;
            }
            const groupDoc = querySnapshot.docs[0];
            const groupData = groupDoc.data();
                   // Check if user is already a member
            if (groupData.members.includes(usuario.uid)) {
                mostrarNotificacion('Ya eres miembro de este grupo.');
                if (joinGroupCodeInput) joinGroupCodeInput.value = '';
                seleccionarGrupo({ ...groupData,
                    id: groupDoc.id
                }); // Select the group if already a member
                return;
            }
            // Add user to group members using arrayUnion
            if (usandoFirebase) {
                await db.collection('groups').doc(groupDoc.id).update({ // Changed groupId to groupDoc.id
                    members: firebase.firestore.FieldValue.arrayUnion(usuario.uid) // Changed userId to usuario.uid
                });
            }
       mostrarNotificacion(`Te has unido al grupo "${groupData.name}".`);
            if (joinGroupCodeInput) joinGroupCodeInput.value = '';
            // Force data refresh and UI update
            await cargarDatosFirebase(); // This will re-fetch groups and update `groups` array
            seleccionarGrupo({ ...groupData,
                id: groupDoc.id
            }); // Select the newly joined group
            renderizarGrupos(); // Re-render the groups list
        } catch (error) {
            console.error('Error al unirse al grupo:', error);
            mostrarNotificacion('Error al unirse al grupo. Verifica el c√≥digo o tus permisos.'); // Mensaje m√°s general
        }
    }

        function eliminarGrupo(id) {
            showConfirm('¬øEst√°s seguro de que quieres eliminar este grupo? Esta acci√≥n es irreversible y eliminar√° el grupo para todos los miembros.', async () => {
                const groupToDelete = groups.find(g => g.id === id);
                if (!groupToDelete) return;

                if (usandoFirebase) {
                    try {
                        // Delete group from Firestore
                        await db.collection('groups').doc(id).delete();
                        // No need to delete tasks/exams/notes from user collections here,
                        // as they are tied to the user's UID and will be deleted with the user's account.
                        // If group-specific items need to be deleted, a more complex query is needed.
                    } catch (error) {
                        console.error("Error al eliminar grupo de Firebase:", error);
                        mostrarNotificacion("Error al eliminar grupo.");
                        return;
                    }
                }
                groups = groups.filter(g => g.id !== id);
                if (groupSeleccionado && groupSeleccionado.id === id) {
                    groupSeleccionado = null;
                    if (tituloTareas) tituloTareas.textContent = 'Tareas Pendientes';
                    if (fixedButtonsContainer) fixedButtonsContainer.style.display = 'none';
                    if (tareasPendientesContainer) tareasPendientesContainer.style.display = 'none';
                    if (examenesPendientesContainer) examenesPendientesContainer.style.display = 'none';
                    if (notesContainer) notesContainer.style.display = 'none';
                    if (tareasCompletadasContainer) tareasCompletadasContainer.style.display = 'none';
                    if (examenesCompletadosContainer) examenesCompletadosContainer.style.display = 'none';
                    if (groupDetailsSection) groupDetailsSection.style.display = 'none';
                    if (teacherGroupCodeDisplay) teacherGroupCodeDisplay.style.display = 'none';
                }
                guardarDatosLocales();
                renderizarGrupos();
                mostrarNotificacion('Grupo eliminado.');
            });
        }

        function leaveGroup(id) {
            showConfirm('¬øEst√°s seguro de que quieres salir de este grupo?', async () => {
                if (usandoFirebase && usuario && usuario.uid) {
                    try {
                        await db.collection('groups').doc(id).update({
                            members: firebase.firestore.FieldValue.arrayRemove(usuario.uid)
                        });
                    } catch (error) {
                        console.error("Error al salir del grupo en Firebase:", error);
                        mostrarNotificacion("Error al salir del grupo.");
                        return;
                    }
                }
                groups = groups.filter(g => g.id !== id);
                if (groupSeleccionado && groupSeleccionado.id === id) {
                    groupSeleccionado = null;
                    if (tituloTareas) tituloTareas.textContent = 'Tareas Pendientes';
                    if (fixedButtonsContainer) fixedButtonsContainer.style.display = 'none';
                    if (tareasPendientesContainer) tareasPendientesContainer.style.display = 'none';
                    if (examenesPendientesContainer) examenesPendientesContainer.style.display = 'none';
                    if (notesContainer) notesContainer.style.display = 'none';
                    if (tareasCompletadasContainer) tareasCompletadasContainer.style.display = 'none';
                    if (examenesCompletadosContainer) examenesCompletadosContainer.style.display = 'none';
                    if (groupDetailsSection) groupDetailsSection.style.display = 'none';
                    if (teacherGroupCodeDisplay) teacherGroupCodeDisplay.style.display = 'none';
                }
                guardarDatosLocales();
                renderizarGrupos();
                mostrarNotificacion('Has salido del grupo.');
            });
        }

        function mostrarNotificacion(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.classList.add('fade-out');
                setTimeout(() => notificacion.remove(), 300);
            }, 4000); 
        }

        function verificarTareasVencidas() {
            const hoy = new Date();
            const tareasVencidas = tareas.filter(t => {
                if (t.completada) return false;
                
                const fechaEntrega = new Date(t.fechaEntrega);
                return fechaEntrega < hoy;
            });
            
            tareasVencidas.forEach(tarea => {
                const materiaNombre = tarea.materia || (tarea.groupId ? groups.find(g => g.id === tarea.groupId)?.name : 'Grupo');
                mostrarNotificacion(`Tarea vencida: ${tarea.descripcion} (${materiaNombre})`);
            });
        }

       function renderizarUIporRol() {
            // La secci√≥n de grupos y unirse a grupos es visible para ambos roles
            // Solo el bot√≥n "Nuevo Grupo" es espec√≠fico de maestros
            if (abrirModalGroupBtn) {
                if (userRole === 'teacher') {
                    abrirModalGroupBtn.style.display = 'block';
                } else {
                    abrirModalGroupBtn.style.display = 'none';
                }
            }
            if (document.getElementById('sidebar-title-materias')) {
                document.getElementById('sidebar-title-materias').textContent = userRole === 'teacher' ? 'Materias Personales' : 'Mis Materias';
            }

            // Re-render lists to apply role-based permissions
            renderizarMaterias();
            renderizarGrupos();
            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();
        }

        // Objeto global para acceder a las funciones desde HTML
       window.app = {
            eliminarMateria,
            editarMateria,
            completarTarea,
            editarTarea,
            eliminarTarea,
            completarExamen,
            editarExamen,
            eliminarExamen,
            editarNota,
            eliminarNota,
            editarGrupo,
            eliminarGrupo,
            leaveGroup,
            removeGroupMember // Expose removeGroupMember to global app object
        };
        
        // Event listener for group members toggle
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-members-btn');
            const groupMembersList = document.getElementById('group-members-list');
            const membersArrow = document.getElementById('members-arrow');
            if (toggleBtn && groupMembersList && membersArrow) {
                toggleBtn.addEventListener('click', function() {
                    if (groupMembersList.style.display === 'none' || groupMembersList.style.display === '') {
                        groupMembersList.style.display = 'block';
                        membersArrow.classList.remove('fa-chevron-down');
                        membersArrow.classList.add('fa-chevron-up');
                    } else {
                        groupMembersList.style.display = 'none';
                        membersArrow.classList.remove('fa-chevron-up');
                        membersArrow.classList.add('fa-chevron-down');
                    }
                });
            }
        });

        // Close settings sub-menus when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const settingsMenu = document.getElementById('settings-menu');
            const themeOptions = document.getElementById('theme-options');
            const roleOptions = document.getElementById('role-options');
            const notificationSettings = document.getElementById('notification-settings');

            document.addEventListener('click', function(e) {
                const isClickInsideSettingsMenu = settingsMenu && settingsMenu.contains(e.target);
                const isClickInsideSubMenu = (themeOptions && themeOptions.contains(e.target)) ||
                                             (roleOptions && roleOptions.contains(e.target)) ||
                                             (notificationSettings && notificationSettings.contains(e.target));
                
                if (!isClickInsideSettingsMenu && !isClickInsideSubMenu) {
                    if (themeOptions) themeOptions.classList.remove('active');
                    if (roleOptions) roleOptions.classList.remove('active');
                    if (notificationSettings) notificationSettings.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>